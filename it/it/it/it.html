
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="Expires" content="8640000">
    <title>サイコロのコンテンツ</title>
    <script>!function(t,e){var n,i;"function"!=typeof Object.defineProperty&&(Object.defineProperty=function(t,e,n){return"value"in n&&(t[e]=n.value),"get"in n&&t.__defineGetter__(e,n.get),"set"in n&&t.__defineSetter__(e,n.set),t}),"function"!=typeof Object.defineProperties&&(Object.defineProperties=function(t,e){for(var n in e)e.hasOwnProperty(n)&&Object.defineProperty(t,n,e[n]);return t}),"function"!=typeof Object.create&&(Object.create=function(t,e){function n(){}n.prototype=t;var i=new n;return null!=e&&Object.defineProperties(i,e),i}),"function"!=typeof Object.getPrototypeOf&&(Object.getPrototypeOf=function(t){return t.__proto__}),"function"!=typeof Function.prototype.bind&&(Function.prototype.bind=function(e){var n=this,i=Array.prototype.slice.call(arguments,1),s=function(){},r=function(){var r=i.concat(Array.prototype.slice.call(arguments));return n.apply(this instanceof s?this:e||t,r)};return s.prototype=n.prototype,r.prototype=new s,r}),t.getTime=t.performance&&t.performance.now?(n=Date.now(),function(){return n+t.performance.now()}):t.performance&&t.performance.webkitNow?(n=Date.now(),function(){return n+t.performance.webkitNow()}):Date.now,t.requestAnimationFrame=t.requestAnimationFrame||t.mozRequestAnimationFrame||t.webkitRequestAnimationFrame||t.msRequestAnimationFrame||(i=t.getTime(),function(e){return setTimeout((function(){i=t.getTime(),e(i)}),Math.max(0,i+16.666666666666668-t.getTime()))});var s,r,a,o=function(e){if(null!=e&&(e instanceof Array||(e=Array.prototype.slice.call(arguments)),e=e.filter((function(t){return[t].join()}))),function n(i,s){var r,a,o=[];for(var h in i)i.hasOwnProperty(h)&&("function"==typeof i[h]?t[h]=i[h]:"object"==typeof i[h]&&null!==i[h]&&Object.getPrototypeOf(i[h])===Object.prototype&&(null==e?o.push(h):-1!==(r=e.indexOf(s+h))&&(o.push(h),e.splice(r,1))));for(r=0,a=o.length;r<a;r++)n(i[o[r]],s+o[r]+".")}(o,""),o.Class.getInheritanceTree(t.Game).length<=o.Class.getInheritanceTree(t.Core).length&&(t.Game=t.Core),null!=e&&e.length)throw new Error("Cannot load module: "+e.join(", "))};t.enchant=o,t.addEventListener("message",(function(t,e){try{var n=JSON.parse(t.data);if("event"===n.type)o.Core.instance.dispatchEvent(new o.Event(n.value));else if("debug"===n.type)switch(n.value){case"start":o.Core.instance.start();break;case"pause":o.Core.instance.pause();break;case"resume":o.Core.instance.resume();break;case"tick":o.Core.instance._tick();break;default:break}}catch(t){}}),!1),o.Class=function(t,e){return o.Class.create(t,e)},o.Class.create=function(t,e){if(null==t&&e)throw new Error("superclass is undefined (enchant.Class.create)");if(null==t)throw new Error("definition is undefined (enchant.Class.create)");if(0===arguments.length)return o.Class.create(Object,e);if(1===arguments.length&&"function"!=typeof arguments[0])return o.Class.create(Object,arguments[0]);for(var n in e)e.hasOwnProperty(n)&&("object"==typeof e[n]&&null!==e[n]&&Object.getPrototypeOf(e[n])===Object.prototype?"enumerable"in e[n]||(e[n].enumerable=!0):e[n]={value:e[n],enumerable:!0,writable:!0});var i=function(){if(!(this instanceof i))return new i;i.prototype.initialize.apply(this,arguments)};i.prototype=Object.create(t.prototype,e),i.prototype.constructor=i,null==i.prototype.initialize&&(i.prototype.initialize=function(){t.apply(this,arguments)});for(var s=this.getInheritanceTree(t),r=0,a=s.length;r<a;r++)if("function"==typeof s[r]._inherited){s[r]._inherited(i);break}return i},o.Class.getInheritanceTree=function(t){for(var e=[],n=t,i=n.prototype;n!==Object;)e.push(n),n=(i=Object.getPrototypeOf(i)).constructor;return e},o.ENV={VERSION:"0.8.2",BROWSER:(r=navigator.userAgent,/Eagle/.test(r)?"eagle":/Opera/.test(r)?"opera":/MSIE|Trident/.test(r)?"ie":/Chrome/.test(r)?"chrome":/(?:Macintosh|Windows).*AppleWebKit/.test(r)?"safari":/(?:iPhone|iPad|iPod).*AppleWebKit/.test(r)?"mobilesafari":/Firefox/.test(r)?"firefox":/Android/.test(r)?"android":""),VENDOR_PREFIX:function(){var t=navigator.userAgent;return-1!==t.indexOf("Opera")?"O":/MSIE|Trident/.test(t)?"ms":-1!==t.indexOf("WebKit")?"webkit":"Gecko"===navigator.product?"Moz":""}(),TOUCH_ENABLED:(s=document.createElement("div"),s.setAttribute("ontouchstart","return"),"function"==typeof s.ontouchstart),RETINA_DISPLAY:function(){if(-1!==navigator.userAgent.indexOf("iPhone")&&2===t.devicePixelRatio){var e=document.querySelector('meta[name="viewport"]');return null==e&&(e=document.createElement("meta"),document.head.appendChild(e)),e.setAttribute("content","width=640"),!0}return!1}(),USE_FLASH_SOUND:function(){var t=navigator.userAgent,e=navigator.vendor||"";return 0===location.href.indexOf("http")&&-1===t.indexOf("Mobile")&&-1!==e.indexOf("Apple")}(),USE_DEFAULT_EVENT_TAGS:["input","textarea","select","area"],CANVAS_DRAWING_METHODS:["putImageData","drawImage","drawFocusRing","fill","stroke","clearRect","fillRect","strokeRect","fillText","strokeText"],KEY_BIND_TABLE:{37:"left",38:"up",39:"right",40:"down"},PREVENT_DEFAULT_KEY_CODES:[37,38,39,40,32],SOUND_ENABLED_ON_MOBILE_SAFARI:!0,USE_TOUCH_TO_START_SCENE:!0,USE_WEBAUDIO:"file:"!==location.protocol,USE_ANIMATION:!0},o.Event=o.Class.create({initialize:function(t){this.type=t,this.target=null,this.x=0,this.y=0,this.localX=0,this.localY=0},_initPosition:function(t,e){var n=o.Core.instance;this.x=this.localX=(t-n._pageX)/n.scale,this.y=this.localY=(e-n._pageY)/n.scale}}),o.Event.LOAD="load",o.Event.ERROR="error",o.Event.CORE_RESIZE="coreresize",o.Event.PROGRESS="progress",o.Event.ENTER_FRAME="enterframe",o.Event.EXIT_FRAME="exitframe",o.Event.ENTER="enter",o.Event.EXIT="exit",o.Event.CHILD_ADDED="childadded",o.Event.ADDED="added",o.Event.ADDED_TO_SCENE="addedtoscene",o.Event.CHILD_REMOVED="childremoved",o.Event.REMOVED="removed",o.Event.REMOVED_FROM_SCENE="removedfromscene",o.Event.TOUCH_START="touchstart",o.Event.TOUCH_MOVE="touchmove",o.Event.TOUCH_END="touchend",o.Event.RENDER="render",o.Event.INPUT_START="inputstart",o.Event.INPUT_CHANGE="inputchange",o.Event.INPUT_END="inputend",o.Event.INPUT_STATE_CHANGED="inputstatechanged",o.Event.LEFT_BUTTON_DOWN="leftbuttondown",o.Event.LEFT_BUTTON_UP="leftbuttonup",o.Event.RIGHT_BUTTON_DOWN="rightbuttondown",o.Event.RIGHT_BUTTON_UP="rightbuttonup",o.Event.UP_BUTTON_DOWN="upbuttondown",o.Event.UP_BUTTON_UP="upbuttonup",o.Event.DOWN_BUTTON_DOWN="downbuttondown",o.Event.DOWN_BUTTON_UP="downbuttonup",o.Event.A_BUTTON_DOWN="abuttondown",o.Event.A_BUTTON_UP="abuttonup",o.Event.B_BUTTON_DOWN="bbuttondown",o.Event.B_BUTTON_UP="bbuttonup",o.Event.ADDED_TO_TIMELINE="addedtotimeline",o.Event.REMOVED_FROM_TIMELINE="removedfromtimeline",o.Event.ACTION_START="actionstart",o.Event.ACTION_END="actionend",o.Event.ACTION_TICK="actiontick",o.Event.ACTION_ADDED="actionadded",o.Event.ACTION_REMOVED="actionremoved",o.Event.ANIMATION_END="animationend",o.EventTarget=o.Class.create({initialize:function(){this._listeners={}},addEventListener:function(t,e){var n=this._listeners[t];null==n?this._listeners[t]=[e]:-1===n.indexOf(e)&&n.unshift(e)},on:function(){this.addEventListener.apply(this,arguments)},removeEventListener:function(t,e){var n=this._listeners[t];if(null!=n){var i=n.indexOf(e);-1!==i&&n.splice(i,1)}},clearEventListener:function(t){null!=t?delete this._listeners[t]:this._listeners={}},dispatchEvent:function(t){t.target=this,t.localX=t.x-this._offsetX,t.localY=t.y-this._offsetY,null!=this["on"+t.type]&&this["on"+t.type](t);var e=this._listeners[t.type];if(null!=e)for(var n=0,i=(e=e.slice()).length;n<i;n++)e[n].call(this,t)}}),o.Core=o.Class.create(o.EventTarget,{initialize:function(e,n){if(null===t.document.body)throw new Error("document.body is null. Please excute 'new Core()' in window.onload.");o.EventTarget.call(this);var i=!0;a&&(i=!1,a.stop()),a=o.Core.instance=this,this._calledTime=0,this._mousedownID=0,this._surfaceID=0,this._soundID=0,this._scenes=[],e=e||320,n=n||320;var s,r,h,c=document.getElementById("enchant-stage");if(c){var d=t.getComputedStyle(c);for(r=parseInt(d.width,10),h=parseInt(d.height,10),s=r&&h?Math.min(r/e,h/n):1;c.firstChild;)c.removeChild(c.firstChild);c.style.position="relative";var u=c.getBoundingClientRect();this._pageX=Math.round(t.scrollX||t.pageXOffset+u.left),this._pageY=Math.round(t.scrollY||t.pageYOffset+u.top)}else(c=document.createElement("div")).id="enchant-stage",c.style.position="absolute",document.body.firstChild?document.body.insertBefore(c,document.body.firstChild):document.body.appendChild(c),s=Math.min(t.innerWidth/e,t.innerHeight/n),this._pageX=c.getBoundingClientRect().left,this._pageY=c.getBoundingClientRect().top;for(var l in c.style.fontSize="12px",c.style.webkitTextSizeAdjust="none",c.style.webkitTapHighlightColor="rgba(0, 0, 0, 0)",this._element=c,this.addEventListener("coreresize",this._oncoreresize),this._width=e,this._height=n,this.scale=s,this.fps=30,this.frame=0,this.ready=!1,this.running=!1,this.assets={},this._assets=[],function t(e){for(var n in e.assets&&o.Core.instance.preload(e.assets),e)e.hasOwnProperty(n)&&"object"==typeof e[n]&&null!==e[n]&&Object.getPrototypeOf(e[n])===Object.prototype&&t(e[n])}(o),this.currentScene=null,this.rootScene=new o.Scene,this.pushScene(this.rootScene),this.loadingScene=new o.LoadingScene,this._activated=!1,this._offsetX=0,this._offsetY=0,this.input={},this.keyboardInputManager=new o.KeyboardInputManager(t.document,this.input),this.keyboardInputManager.addBroadcastTarget(this),this._keybind=this.keyboardInputManager._binds,o.ENV.KEY_BIND_TABLE||(o.ENV.KEY_BIND_TABLE={}),o.ENV.KEY_BIND_TABLE)this.keybind(l,o.ENV.KEY_BIND_TABLE[l]);i&&(c=o.Core.instance._element,document.addEventListener("keydown",(function(t){a.dispatchEvent(new o.Event("keydown")),-1!==o.ENV.PREVENT_DEFAULT_KEY_CODES.indexOf(t.keyCode)&&(t.preventDefault(),t.stopPropagation())}),!0),o.ENV.TOUCH_ENABLED&&(c.addEventListener("touchstart",(function(t){var e=t.target.tagName.toLowerCase();-1===o.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(e)&&(t.preventDefault(),a.running||t.stopPropagation())}),!0),c.addEventListener("touchmove",(function(t){var e=t.target.tagName.toLowerCase();-1===o.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(e)&&(t.preventDefault(),a.running||t.stopPropagation())}),!0),c.addEventListener("touchend",(function(t){var e=t.target.tagName.toLowerCase();-1===o.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(e)&&(t.preventDefault(),a.running||t.stopPropagation())}),!0)),c.addEventListener("mousedown",(function(t){var e=t.target.tagName.toLowerCase();-1===o.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(e)&&(t.preventDefault(),a._mousedownID++,a.running||t.stopPropagation())}),!0),c.addEventListener("mousemove",(function(t){var e=t.target.tagName.toLowerCase();-1===o.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(e)&&(t.preventDefault(),a.running||t.stopPropagation())}),!0),c.addEventListener("mouseup",(function(t){var e=t.target.tagName.toLowerCase();-1===o.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(e)&&(t.preventDefault(),a.running||t.stopPropagation())}),!0),a._touchEventTarget={},o.ENV.TOUCH_ENABLED&&(c.addEventListener("touchstart",(function(t){for(var e,n,i=o.Core.instance,s=new o.Event(o.Event.TOUCH_START),r=t.changedTouches,a=0,h=r.length;a<h;a++)e=r[a],s._initPosition(e.pageX,e.pageY),n=i.currentScene._determineEventTarget(s),i._touchEventTarget[e.identifier]=n,n.dispatchEvent(s)}),!1),c.addEventListener("touchmove",(function(t){for(var e,n,i=o.Core.instance,s=new o.Event(o.Event.TOUCH_MOVE),r=t.changedTouches,a=0,h=r.length;a<h;a++)e=r[a],(n=i._touchEventTarget[e.identifier])&&(s._initPosition(e.pageX,e.pageY),n.dispatchEvent(s))}),!1),c.addEventListener("touchend",(function(t){for(var e,n,i=o.Core.instance,s=new o.Event(o.Event.TOUCH_END),r=t.changedTouches,a=0,h=r.length;a<h;a++)e=r[a],(n=i._touchEventTarget[e.identifier])&&(s._initPosition(e.pageX,e.pageY),n.dispatchEvent(s),delete i._touchEventTarget[e.identifier])}),!1)),c.addEventListener("mousedown",(function(t){var e=o.Core.instance,n=new o.Event(o.Event.TOUCH_START);n._initPosition(t.pageX,t.pageY);var i=e.currentScene._determineEventTarget(n);e._touchEventTarget[e._mousedownID]=i,i.dispatchEvent(n)}),!1),c.addEventListener("mousemove",(function(t){var e=o.Core.instance,n=new o.Event(o.Event.TOUCH_MOVE);n._initPosition(t.pageX,t.pageY);var i=e._touchEventTarget[e._mousedownID];i&&i.dispatchEvent(n)}),!1),c.addEventListener("mouseup",(function(t){var e=o.Core.instance,n=new o.Event(o.Event.TOUCH_END);n._initPosition(t.pageX,t.pageY);var i=e._touchEventTarget[e._mousedownID];i&&i.dispatchEvent(n),delete e._touchEventTarget[e._mousedownID]}),!1))},width:{get:function(){return this._width},set:function(t){this._width=t,this._dispatchCoreResizeEvent()}},height:{get:function(){return this._height},set:function(t){this._height=t,this._dispatchCoreResizeEvent()}},scale:{get:function(){return this._scale},set:function(t){this._scale=t,this._dispatchCoreResizeEvent()}},_dispatchCoreResizeEvent:function(){var t=new o.Event("coreresize");t.width=this._width,t.height=this._height,t.scale=this._scale,this.dispatchEvent(t)},_oncoreresize:function(t){this._element.style.width=Math.floor(this._width*this._scale)+"px",this._element.style.height=Math.floor(this._height*this._scale)+"px";for(var e=0,n=this._scenes.length;e<n;e++)this._scenes[e].dispatchEvent(t)},preload:function(t){var e;if(!(t instanceof Array))if("object"==typeof t){for(var n in e=[],t)t.hasOwnProperty(n)&&e.push([t[n],n]);t=e}else t=Array.prototype.slice.call(arguments);return Array.prototype.push.apply(this._assets,t),this},load:function(t,e,n,i){var s;if("string"==typeof arguments[1])s=e,n=n||function(){},i=i||function(){};else{s=t;var r=n;n=arguments[1]||function(){},i=r||function(){}}var h=o.Core.findExt(t);return o.Deferred.next((function(){var e=new o.Deferred,r=function(t){e.call(t),n.call(this,t)},c=function(t){e.fail(t),i.call(this,t)};if(o.Core._loadFuncs[h])o.Core.instance.assets[s]=o.Core._loadFuncs[h](t,h,r,c);else{var d=new XMLHttpRequest;d.open("GET",t,!0),d.onreadystatechange=function(){if(4===d.readyState){if(200!==d.status&&0!==d.status){var e=new o.Event("error");e.message=d.status+": Cannot load an asset: "+t,c.call(o.Core.instance,e)}var n=d.getResponseHeader("Content-Type")||"";n.match(/^image/)?a.assets[s]=o.Surface.load(t,r,c):n.match(/^audio/)?a.assets[s]=o.Sound.load(t,n,r,c):(a.assets[s]=d.responseText,r.call(o.Core.instance,new o.Event("load")))}},d.send(null)}return e}))},start:function(e){var n=function(){this.frame=0,this.removeEventListener("load",n)};if(this.addEventListener("load",n),this.currentTime=t.getTime(),this.running=!0,this.ready=!0,!this._activated&&(this._activated=!0,"mobilesafari"===o.ENV.BROWSER&&o.ENV.USE_WEBAUDIO&&o.ENV.USE_TOUCH_TO_START_SCENE)){var i=new o.Deferred,s=this._createTouchToStartScene();return s.addEventListener(o.Event.TOUCH_START,(function t(){this.removeEventListener(o.Event.TOUCH_START,t);var e=new o.WebAudioSound;e.buffer=o.WebAudioSound.audioContext.createBuffer(1,1,48e3),e.play(),a.removeScene(s),a.start(i)}),!1),a.pushScene(s),i}this._requestNextFrame(0);var r=this._requestPreload().next((function(){o.Core.instance.loadingScene.dispatchEvent(new o.Event(o.Event.LOAD))}));return e&&r.next((function(t){e.call(t)})).error((function(t){e.fail(t)})),r},_requestPreload:function(){var t={},e=0,n=0,i=function(){var t=new o.Event("progress");t.loaded=++e,t.total=n,a.loadingScene.dispatchEvent(t)};return this._assets.reverse().forEach((function(e){var s,r;e instanceof Array?(s=e[0],r=e[1]):s=r=e,t[r]||(t[r]=this.load(s,r,i),n++)}),this),this.pushScene(this.loadingScene),o.Deferred.parallel(t)},_createTouchToStartScene:function(){var t=new o.Label("Touch to Start"),e=Math.round(a.width/10),n=new o.Scene;return t.color="#fff",t.font=e-1+"px bold Helvetica,Arial,sans-serif",t.textAlign="center",t.width=a.width,t.height=t._boundHeight,t.y=(a.height-t.height)/2,n.backgroundColor="#000",n.addChild(t),n},debug:function(){return this._debug=!0,this.start()},actualFps:{get:function(){return this._actualFps||this.fps}},_requestNextFrame:function(e){this.ready&&(this.fps>=60||e<=16?(this._calledTime=t.getTime(),t.requestAnimationFrame(this._callTick)):setTimeout((function(){var e=o.Core.instance;e._calledTime=t.getTime(),t.requestAnimationFrame(e._callTick)}),Math.max(0,e)))},_callTick:function(t){o.Core.instance._tick(t)},_tick:function(e){var n=new o.Event("enterframe"),i=t.getTime(),s=n.elapsed=i-this.currentTime;this._actualFps=s>0?1e3/s:0;for(var r=this.currentScene.childNodes.slice(),a=Array.prototype.push;r.length;){var h=r.pop();h.age++,h.dispatchEvent(n),h.childNodes&&a.apply(r,h.childNodes)}this.currentScene.age++,this.currentScene.dispatchEvent(n),this.dispatchEvent(n),this.dispatchEvent(new o.Event("exitframe")),this.frame++,i=t.getTime(),this.currentTime=i,this._requestNextFrame(1e3/this.fps-(i-this._calledTime))},getTime:function(){return t.getTime()},stop:function(){this.ready=!1,this.running=!1},pause:function(){this.ready=!1},resume:function(){this.ready||(this.currentTime=t.getTime(),this.ready=!0,this.running=!0,this._requestNextFrame(0))},pushScene:function(t){return this._element.appendChild(t._element),this.currentScene&&this.currentScene.dispatchEvent(new o.Event("exit")),this.currentScene=t,this.currentScene.dispatchEvent(new o.Event("enter")),this._scenes.push(t)},popScene:function(){return this.currentScene===this.rootScene?this.currentScene:(this._element.removeChild(this.currentScene._element),this.currentScene.dispatchEvent(new o.Event("exit")),this.currentScene=this._scenes[this._scenes.length-2],this.currentScene.dispatchEvent(new o.Event("enter")),this._scenes.pop())},replaceScene:function(t){return this.popScene(),this.pushScene(t)},removeScene:function(t){if(this.currentScene===t)return this.popScene();var e=this._scenes.indexOf(t);return-1!==e?(this._scenes.splice(e,1),this._element.removeChild(t._element),t):null},_buttonListener:function(t){this.currentScene.dispatchEvent(t)},keybind:function(t,e){return this.keyboardInputManager.keybind(t,e),this.addEventListener(e+"buttondown",this._buttonListener),this.addEventListener(e+"buttonup",this._buttonListener),this},keyunbind:function(t){var e=this._keybind[t];return this.keyboardInputManager.keyunbind(t),this.removeEventListener(e+"buttondown",this._buttonListener),this.removeEventListener(e+"buttonup",this._buttonListener),this},changeButtonState:function(t,e){this.keyboardInputManager.changeState(t,e)},getElapsedTime:function(){return this.frame/this.fps}}),o.Core._loadFuncs={},o.Core._loadFuncs.jpg=o.Core._loadFuncs.jpeg=o.Core._loadFuncs.gif=o.Core._loadFuncs.png=o.Core._loadFuncs.webp=o.Core._loadFuncs.bmp=function(t,e,n,i){return o.Surface.load(t,n,i)},o.Core._loadFuncs.mp3=o.Core._loadFuncs.aac=o.Core._loadFuncs.m4a=o.Core._loadFuncs.wav=o.Core._loadFuncs.ogg=function(t,e,n,i){return o.Sound.load(t,"audio/"+e,n,i)},o.Core.findExt=function(t){var e=t.match(/\.\w+$/);return e&&e.length>0?e[0].slice(1).toLowerCase():0===t.indexOf("data:")?t.split(/[\/;]/)[1].toLowerCase():null},o.Core.instance=null,o.Game=o.Core,o.InputManager=o.Class.create(o.EventTarget,{initialize:function(t,e){o.EventTarget.call(this),this.broadcastTarget=[],this.valueStore=t,this.source=e||this,this._binds={},this._stateHandler=function(t){var e=t.source.identifier,n=this._binds[e];this.changeState(n,t.data)}.bind(this)},bind:function(t,e){t.addEventListener(o.Event.INPUT_STATE_CHANGED,this._stateHandler),this._binds[t.identifier]=e},unbind:function(t){t.removeEventListener(o.Event.INPUT_STATE_CHANGED,this._stateHandler),delete this._binds[t.identifier]},addBroadcastTarget:function(t){-1===this.broadcastTarget.indexOf(t)&&this.broadcastTarget.push(t)},removeBroadcastTarget:function(t){var e=this.broadcastTarget.indexOf(t);-1!==e&&this.broadcastTarget.splice(e,1)},broadcastEvent:function(t){for(var e=this.broadcastTarget,n=0,i=e.length;n<i;n++)e[n].dispatchEvent(t)},changeState:function(t,e){}}),o.InputSource=o.Class.create(o.EventTarget,{initialize:function(t){o.EventTarget.call(this),this.identifier=t},notifyStateChange:function(t){var e=new o.Event(o.Event.INPUT_STATE_CHANGED);e.data=t,e.source=this,this.dispatchEvent(e)}}),o.BinaryInputManager=o.Class.create(o.InputManager,{initialize:function(t,e,n,i){o.InputManager.call(this,t,i),this.activeInputsNum=0,this.activeEventNameSuffix=e,this.inactiveEventNameSuffix=n},bind:function(t,e){o.InputManager.prototype.bind.call(this,t,e),this.valueStore[e]=!1},unbind:function(t){var e=this._binds[t.identifier];o.InputManager.prototype.unbind.call(this,t),delete this.valueStore[e]},changeState:function(t,e){e?this._down(t):this._up(t)},_down:function(t){var e;this.valueStore[t]||(this.valueStore[t]=!0,(e=new o.Event(this.activeInputsNum++?"inputchange":"inputstart")).source=this.source,this.broadcastEvent(e));var n=new o.Event(t+this.activeEventNameSuffix);n.source=this.source,this.broadcastEvent(n)},_up:function(t){var e;this.valueStore[t]&&(this.valueStore[t]=!1,(e=new o.Event(--this.activeInputsNum?"inputchange":"inputend")).source=this.source,this.broadcastEvent(e));var n=new o.Event(t+this.inactiveEventNameSuffix);n.source=this.source,this.broadcastEvent(n)}}),o.BinaryInputSource=o.Class.create(o.InputSource,{initialize:function(t){o.InputSource.call(this,t)}}),o.KeyboardInputManager=o.Class.create(o.BinaryInputManager,{initialize:function(t,e){o.BinaryInputManager.call(this,e,"buttondown","buttonup"),this._attachDOMEvent(t,"keydown",!0),this._attachDOMEvent(t,"keyup",!1)},keybind:function(t,e){this.bind(o.KeyboardInputSource.getByKeyCode(""+t),e)},keyunbind:function(t){this.unbind(o.KeyboardInputSource.getByKeyCode(""+t))},_attachDOMEvent:function(t,e,n){t.addEventListener(e,(function(t){var e=o.Core.instance;if(e&&e.running){var i=t.keyCode,s=o.KeyboardInputSource._instances[i];s&&s.notifyStateChange(n)}}),!0)}}),o.KeyboardInputSource=o.Class.create(o.BinaryInputSource,{initialize:function(t){o.BinaryInputSource.call(this,t)}}),o.KeyboardInputSource._instances={},o.KeyboardInputSource.getByKeyCode=function(t){return this._instances[t]||(this._instances[t]=new o.KeyboardInputSource(t)),this._instances[t]},o.Node=o.Class.create(o.EventTarget,{initialize:function(){o.EventTarget.call(this),this._dirty=!1,this._matrix=[1,0,0,1,0,0],this._x=0,this._y=0,this._offsetX=0,this._offsetY=0,this.age=0,this.parentNode=null,this.scene=null,this.addEventListener("touchstart",(function(t){this.parentNode&&this.parentNode.dispatchEvent(t)})),this.addEventListener("touchmove",(function(t){this.parentNode&&this.parentNode.dispatchEvent(t)})),this.addEventListener("touchend",(function(t){this.parentNode&&this.parentNode.dispatchEvent(t)})),o.ENV.USE_ANIMATION&&(this.tl=new o.Timeline(this))},moveTo:function(t,e){this._x=t,this._y=e,this._dirty=!0},moveBy:function(t,e){this._x+=t,this._y+=e,this._dirty=!0},x:{get:function(){return this._x},set:function(t){this._x=t,this._dirty=!0}},y:{get:function(){return this._y},set:function(t){this._y=t,this._dirty=!0}},_updateCoordinate:function(){var t=this,e=[t],n=t.parentNode;for(this.scene;n&&t._dirty;)e.unshift(n),n=(t=t.parentNode).parentNode;var i,s,r,a=o.Matrix.instance,h=a.stack,c=[];h.push(e[0]._matrix);for(var d=1,u=e.length;d<u;d++){t=e[d],i=[],a.makeTransformMatrix(t,c),a.multiply(h[h.length-1],c,i),t._matrix=i,h.push(i);var l=[s="number"==typeof t._originX?t._originX:t._width/2||0,r="number"==typeof t._originY?t._originY:t._height/2||0];a.multiplyVec(i,l,l),t._offsetX=l[0]-s,t._offsetY=l[1]-r,t._dirty=!1}a.reset()},remove:function(){this._listener&&this.clearEventListener(),this.parentNode&&this.parentNode.removeChild(this)}});var h=function(t,e){for(var n,i=[],s=0,r=t.collection.length;s<r;s++)n=t.collection[s],e._intersectOne(n)&&i.push(n);return i},c=function(t,e){for(var n,i=[],s=0,r=t.collection.length;s<r;s++)n=t.collection[s],e._intersectStrictOne(n)&&i.push(n);return i},d=function(t){return t instanceof o.Entity?h(this,t):!("function"!=typeof t||!t.collection)&&function(t,e){for(var n,i,s=[],r=0,a=t.collection.length;r<a;r++){n=t.collection[r];for(var o=0,h=e.collection.length;o<h;o++)i=e.collection[o],n._intersectOne(i)&&s.push([n,i])}return s}(this,t)},u=function(t){return t instanceof o.Entity?c(this,t):!("function"!=typeof t||!t.collection)&&function(t,e){for(var n,i,s=[],r=0,a=t.collection.length;r<a;r++){n=t.collection[r];for(var o=0,h=e.collection.length;o<h;o++)i=e.collection[o],n._intersectStrictOne(i)&&s.push([n,i])}return s}(this,t)};o.Entity=o.Class.create(o.Node,{initialize:function(){var t=o.Core.instance;o.Node.call(this),this._rotation=0,this._scaleX=1,this._scaleY=1,this._touchEnabled=!0,this._clipping=!1,this._originX=null,this._originY=null,this._width=0,this._height=0,this._backgroundColor=null,this._debugColor="#0000ff",this._opacity=1,this._visible=!0,this._buttonMode=null,this._style={},this.__styleStatus={},this._isContainedInCollection=!1,this.compositeOperation=null,this.buttonMode=null,this.buttonPressed=!1,this.addEventListener("touchstart",(function(){this.buttonMode&&(this.buttonPressed=!0,this.dispatchEvent(new o.Event(this.buttonMode+"buttondown")),t.changeButtonState(this.buttonMode,!0))})),this.addEventListener("touchend",(function(){this.buttonMode&&(this.buttonPressed=!1,this.dispatchEvent(new o.Event(this.buttonMode+"buttonup")),t.changeButtonState(this.buttonMode,!1))})),this.enableCollection()},width:{get:function(){return this._width},set:function(t){this._width=t,this._dirty=!0}},height:{get:function(){return this._height},set:function(t){this._height=t,this._dirty=!0}},backgroundColor:{get:function(){return this._backgroundColor},set:function(t){this._backgroundColor=t}},debugColor:{get:function(){return this._debugColor},set:function(t){this._debugColor=t}},opacity:{get:function(){return this._opacity},set:function(t){this._opacity=parseFloat(t)}},visible:{get:function(){return this._visible},set:function(t){this._visible=t}},touchEnabled:{get:function(){return this._touchEnabled},set:function(t){this._touchEnabled=t,this._style.pointerEvents=t?"all":"none"}},intersect:function(t){return t instanceof o.Entity?this._intersectOne(t):!("function"!=typeof t||!t.collection)&&h(t,this)},_intersectOne:function(t){return this._dirty&&this._updateCoordinate(),t._dirty&&t._updateCoordinate(),this._offsetX<t._offsetX+t.width&&t._offsetX<this._offsetX+this.width&&this._offsetY<t._offsetY+t.height&&t._offsetY<this._offsetY+this.height},intersectStrict:function(t){return t instanceof o.Entity?this._intersectStrictOne(t):!("function"!=typeof t||!t.collection)&&c(t,this)},_intersectStrictOne:function(t){this._dirty&&this._updateCoordinate(),t._dirty&&t._updateCoordinate();var e,n,i,s,r,a,o,h,c,d,u,l,f,_,v,E,g,m,p,y,C,T,w,N=this.getOrientedBoundingRect(),x=t.getOrientedBoundingRect(),b=N.leftTop,S=N.rightTop,O=N.leftBottom,A=N.rightBottom,D=x.leftTop,M=x.rightTop,I=x.leftBottom,L=x.rightBottom,R=b[0],U=b[1],P=S[0],B=S[1],k=O[0],F=O[1],X=A[0],Y=A[1],V=D[0],H=D[1],z=M[0],W=M[1],q=I[0],G=I[1],j=L[0],K=L[1],Q=[P-R,B-U],Z=[X-P,Y-B],J=[k-X,F-Y],$=[R-k,U-F],tt=[z-V,W-H],et=[j-z,K-W],nt=[q-j,G-K],it=[V-q,H-G],st=R+P+k+X>>2,rt=U+B+F+Y>>2,at=V+z+q+j>>2,ot=H+W+G+K>>2;if(Q[0]*(ot-U)-Q[1]*(at-R)>0&&Z[0]*(ot-B)-Z[1]*(at-P)>0&&J[0]*(ot-Y)-J[1]*(at-X)>0&&$[0]*(ot-F)-$[1]*(at-k)>0)return!0;if(tt[0]*(rt-H)-tt[1]*(st-V)>0&&et[0]*(rt-W)-et[1]*(st-z)>0&&nt[0]*(rt-K)-nt[1]*(st-j)>0&&it[0]*(rt-G)-it[1]*(st-q)>0)return!0;for(i=[b,S,A,O],s=[D,M,L,I],r=[Q,Z,J,$],a=[tt,et,nt,it],e=0;e<4;e++)for(u=(o=i[e])[0],l=o[1],v=(c=r[e])[0],E=c[1],n=0;n<4;n++)if(f=(h=s[n])[0],_=h[1],g=(d=a[n])[0],0!==(C=v*(m=d[1])-E*g)&&(w=((p=f-u)*m-(y=_-l)*g)/C,0<(T=(p*E-y*v)/C)&&T<1&&0<w&&w<1))return!0;return!1},within:function(t,e){var n;return this._dirty&&this._updateCoordinate(),t._dirty&&t._updateCoordinate(),null==e&&(e=(this.width+this.height+t.width+t.height)/4),(n=this._offsetX-t._offsetX+(this.width-t.width)/2)*n+(n=this._offsetY-t._offsetY+(this.height-t.height)/2)*n<e*e},scale:function(t,e){this._scaleX*=t,this._scaleY*=null!=e?e:t,this._dirty=!0},rotate:function(t){this._rotation+=t,this._dirty=!0},scaleX:{get:function(){return this._scaleX},set:function(t){this._scaleX=t,this._dirty=!0}},scaleY:{get:function(){return this._scaleY},set:function(t){this._scaleY=t,this._dirty=!0}},rotation:{get:function(){return this._rotation},set:function(t){this._rotation=t,this._dirty=!0}},originX:{get:function(){return this._originX},set:function(t){this._originX=t,this._dirty=!0}},originY:{get:function(){return this._originY},set:function(t){this._originY=t,this._dirty=!0}},enableCollection:function(){this.addEventListener("addedtoscene",this._addSelfToCollection),this.addEventListener("removedfromscene",this._removeSelfFromCollection),this.scene&&this._addSelfToCollection()},disableCollection:function(){this.removeEventListener("addedtoscene",this._addSelfToCollection),this.removeEventListener("removedfromscene",this._removeSelfFromCollection),this.scene&&this._removeSelfFromCollection()},_addSelfToCollection:function(){this._isContainedInCollection||(this.getConstructor()._collectionTarget.forEach((function(t){t.collection.push(this)}),this),this._isContainedInCollection=!0)},_removeSelfFromCollection:function(){this._isContainedInCollection&&(this.getConstructor()._collectionTarget.forEach((function(t){var e=t.collection.indexOf(this);-1!==e&&t.collection.splice(e,1)}),this),this._isContainedInCollection=!1)},getBoundingRect:function(){var t=this.width||0,e=this.height||0,n=this._matrix,i=n[0]*t,s=n[1]*t,r=n[2]*e,a=n[3]*e,o=n[4],h=n[5],c=[o,i+o,r+o,i+r+o].sort((function(t,e){return t-e})),d=[h,s+h,a+h,s+a+h].sort((function(t,e){return t-e}));return{left:c[0],top:d[0],width:c[3]-c[0],height:d[3]-d[0]}},getOrientedBoundingRect:function(){var t=this.width||0,e=this.height||0,n=this._matrix,i=n[0]*t,s=n[1]*t,r=n[2]*e,a=n[3]*e,o=n[4],h=n[5];return{leftTop:[o,h],rightTop:[i+o,s+h],leftBottom:[r+o,a+h],rightBottom:[i+r+o,s+a+h]}},getConstructor:function(){return Object.getPrototypeOf(this).constructor}});var l=function(t){if(!t._collective){var e=o.Class.getInheritanceTree(t),n=e.indexOf(o.Entity);t._collectionTarget=-1!==n?e.splice(0,n+1):[],t.intersect=d,t.intersectStrict=u,t.collection=[],t._collective=!0}};l(o.Entity),o.Entity._inherited=function(t){l(t)},o.Sprite=o.Class.create(o.Entity,{initialize:function(t,e){o.Entity.call(this),this.width=t,this.height=e,this._image=null,this._debugColor="#ff0000",this._frameLeft=0,this._frameTop=0,this._frame=0,this._frameSequence=[],this.addEventListener(o.Event.ENTER_FRAME,this._rotateFrameSequence)},image:{get:function(){return this._image},set:function(t){if(t===e)throw new Error("Assigned value on Sprite.image is undefined. Please double-check image path, and check if the image you want to use is preload before use.");t!==this._image&&(this._image=t,this._computeFramePosition())}},frame:{get:function(){return this._frame},set:function(t){this._frame===t||t instanceof Array&&this._deepCompareToPreviousFrame(t)||(t instanceof Array?(this._frameSequence=t.slice(),this._originalFrameSequence=t.slice(),this._rotateFrameSequence()):(this._frameSequence=[],this._frame=t,this._computeFramePosition()))}},_deepCompareToPreviousFrame:function(t){if(t===this._originalFrameSequence)return!0;if(null==t||null==this._originalFrameSequence)return!1;if(t.length!==this._originalFrameSequence.length)return!1;for(var e=0;e<t.length;++e)if(t[e]!==this._originalFrameSequence[e])return!1;return!0},_computeFramePosition:function(){var t,e=this._image;null!=e&&(t=e.width/this._width|0,this._frameLeft=(this._frame%t|0)*this._width,this._frameTop=(this._frame/t|0)*this._height%e.height)},_rotateFrameSequence:function(){if(0!==this._frameSequence.length){var t=this._frameSequence.shift();null===t?(this._frameSequence=[],this.dispatchEvent(new o.Event(o.Event.ANIMATION_END))):(this._frame=t,this._computeFramePosition(),this._frameSequence.push(t))}},width:{get:function(){return this._width},set:function(t){this._width=t,this._computeFramePosition(),this._dirty=!0}},height:{get:function(){return this._height},set:function(t){this._height=t,this._computeFramePosition(),this._dirty=!0}},cvsRender:function(t){var e,n,i,s,r,a,h,c=this._image,d=this._width,u=this._height;c&&0!==d&&0!==u&&(e=c.width,n=c.height,e<d||n<u?(t.fillStyle=o.Surface._getPattern(c),t.fillRect(0,0,d,u)):(i=c._element,s=this._frameLeft,r=Math.min(this._frameTop,n-u),a=Math.max(.01,Math.min(e-s,d)),h=Math.max(.01,Math.min(n-r,u)),t.drawImage(i,s,r,a,h,0,0,d,u)))},domRender:(o.ENV.VENDOR_PREFIX,function(t){this._image&&(this._image._css?(this._style["background-image"]=this._image._css,this._style["background-position"]=-this._frameLeft+"px "+-this._frameTop+"px"):this._image._element)})}),o.Label=o.Class.create(o.Entity,{initialize:function(t){o.Entity.call(this),this.text=t||"",this.width=300,this.font="14px serif",this.textAlign="left",this._debugColor="#ff0000"},width:{get:function(){return this._width},set:function(t){this._width=t,this._dirty=!0,this.updateBoundArea()}},text:{get:function(){return this._text},set:function(t){if(t=""+t,this._text!==t){this._text=t,t=t.replace(/<(br|BR) ?\/?>/g,"<br/>"),this._splitText=t.split("<br/>"),this.updateBoundArea();for(var e=0,n=this._splitText.length;e<n;e++){t=this._splitText[e];var i=this.getMetrics(t);this._splitText[e]={},this._splitText[e].text=t,this._splitText[e].height=i.height}}}},textAlign:{get:function(){return this._style["text-align"]},set:function(t){this._style["text-align"]=t,this.updateBoundArea()}},font:{get:function(){return this._style.font},set:function(t){this._style.font=t,this.updateBoundArea()}},color:{get:function(){return this._style.color},set:function(t){this._style.color=t}},cvsRender:function(t){var e,n,i,s,r,a,o,h,c=0,d=this.width;if(this._splitText){t.textBaseline="top",t.font=this.font,t.fillStyle=this.color||"#000000",n=d/t.measureText(" ").width;for(var u=0,l=this._splitText.length;u<l;u++){for(s=(i=this._splitText[u]).text,r=0;s.length>r+n||t.measureText(s.slice(r,r+n)).width>d;){for(a="",o=n,h=0;o>0;)t.measureText(a).width<d?(h+=o,a=s.slice(r,r+h)):(h-=o,a=s.slice(r,r+h)),o=o/2|0;t.fillText(a,0,c),c+=i.height-1,r+=h}a=s.slice(r,r+s.length),e="right"===this.textAlign?d-t.measureText(a).width:"center"===this.textAlign?(d-t.measureText(a).width)/2:0,t.fillText(a,e,c),c+=i.height-1}}},domRender:function(t){t.innerHTML!==this._text&&(t.innerHTML=this._text)},detectRender:function(t){t.fillRect(this._boundOffset,0,this._boundWidth,this._boundHeight)},updateBoundArea:function(){var t=this.getMetrics();this._boundWidth=t.width,this._boundHeight=t.height,"right"===this.textAlign?this._boundOffset=this.width-this._boundWidth:"center"===this.textAlign?this._boundOffset=(this.width-this._boundWidth)/2:this._boundOffset=0},getMetrics:function(t){var e,n={};if(document.body){for(var i in e=document.createElement("div"),this._style)"width"!==i&&"height"!==i&&(e.style[i]=this._style[i]);t=t||this._text,e.innerHTML=t.replace(/ /g,"&nbsp;"),e.style.whiteSpace="noWrap",e.style.lineHeight=1,document.body.appendChild(e),n.height=parseInt(getComputedStyle(e).height,10)+1,e.style.position="absolute",n.width=parseInt(getComputedStyle(e).width,10)+1,document.body.removeChild(e)}else n.width=this.width,n.height=this.height;return n}}),o.Map=o.Class.create(o.Entity,{initialize:function(t,e){var n=o.Core.instance;o.Entity.call(this);var i=new o.Surface(n.width,n.height);this._surface=i;var s=i._element;s.style.position="absolute",o.ENV.RETINA_DISPLAY&&2===n.scale?(s.width=2*n.width,s.height=2*n.height,this._style.webkitTransformOrigin="0 0",this._style.webkitTransform="scale(0.5)"):(s.width=n.width,s.height=n.height),this._context=s.getContext("2d"),this._tileWidth=t||0,this._tileHeight=e||0,this._image=null,this._data=[[[]]],this._dirty=!1,this._tight=!1,this.touchEnabled=!1,this.collisionData=null,this._listeners.render=null,this.addEventListener("render",(function(){if(this._dirty||null==this._previousOffsetX)this.redraw(0,0,n.width,n.height);else if(this._offsetX!==this._previousOffsetX||this._offsetY!==this._previousOffsetY)if(this._tight){var t=-this._offsetX,e=-this._offsetY,i=-this._previousOffsetX,s=-this._previousOffsetY,r=t-i+n.width,a=i-t+n.width,o=e-s+n.height,h=s-e+n.height;if(r>this._tileWidth&&a>this._tileWidth&&o>this._tileHeight&&h>this._tileHeight){var c,d,u,l,f,_;r<a?(c=0,u=i-t,f=r):(c=t-i,u=0,f=a),o<h?(d=0,l=s-e,_=o):(d=e-s,l=0,_=h),null==n._buffer&&(n._buffer=document.createElement("canvas"),n._buffer.width=this._context.canvas.width,n._buffer.height=this._context.canvas.height);var v=n._buffer.getContext("2d");this._doubledImage?(v.clearRect(0,0,2*f,2*_),v.drawImage(this._context.canvas,2*c,2*d,2*f,2*_,0,0,2*f,2*_),(v=this._context).clearRect(2*u,2*l,2*f,2*_),v.drawImage(n._buffer,0,0,2*f,2*_,2*u,2*l,2*f,2*_)):(v.clearRect(0,0,f,_),v.drawImage(this._context.canvas,c,d,f,_,0,0,f,_),(v=this._context).clearRect(u,l,f,_),v.drawImage(n._buffer,0,0,f,_,u,l,f,_)),0===u?this.redraw(f,0,n.width-f,n.height):this.redraw(0,0,n.width-f,n.height),0===l?this.redraw(0,_,n.width,n.height-_):this.redraw(0,0,n.width,n.height-_)}else this.redraw(0,0,n.width,n.height)}else this.redraw(0,0,n.width,n.height);this._previousOffsetX=this._offsetX,this._previousOffsetY=this._offsetY}))},loadData:function(t){this._data=Array.prototype.slice.apply(arguments),this._dirty=!0,this._tight=!1;for(var e=0,n=this._data.length;e<n;e++){for(var i=0,s=0,r=(t=this._data[e]).length;s<r;s++)for(var a=0,o=t[s].length;a<o;a++)t[s][a]>=0&&i++;if(i/(t.length*t[0].length)>.2){this._tight=!0;break}}},checkTile:function(t,e){if(t<0||this.width<=t||e<0||this.height<=e)return!1;var n=this._image.width,i=this._image.height;return t=t/(this._tileWidth||n)|0,e=e/(this._tileHeight||i)|0,this._data[0][e][t]},hitTest:function(t,e){if(t<0||this.width<=t||e<0||this.height<=e)return!1;var n=this._image.width,i=this._image.height,s=this._tileWidth||n,r=this._tileHeight||i;if(t=t/s|0,e=e/r|0,null!=this.collisionData)return this.collisionData[e]&&!!this.collisionData[e][t];for(var a=0,o=this._data.length;a<o;a++){var h,c=this._data[a];if(null!=c[e]&&null!=(h=c[e][t])&&0<=h&&h<(n/s|0)*(i/r|0))return!0}return!1},image:{get:function(){return this._image},set:function(t){var e=o.Core.instance;if(this._image=t,o.ENV.RETINA_DISPLAY&&2===e.scale){for(var n=new o.Surface(2*t.width,2*t.height),i=this._tileWidth||t.width,s=this._tileHeight||t.height,r=t.width/i|0,a=t.height/s|0,h=0;h<a;h++)for(var c=0;c<r;c++)n.draw(t,c*i,h*s,i,s,c*i*2,h*s*2,2*i,2*s);this._doubledImage=n}this._dirty=!0}},tileWidth:{get:function(){return this._tileWidth},set:function(t){this._tileWidth=t,this._dirty=!0}},tileHeight:{get:function(){return this._tileHeight},set:function(t){this._tileHeight=t,this._dirty=!0}},width:{get:function(){return this._tileWidth*this._data[0][0].length}},height:{get:function(){return this._tileHeight*this._data[0].length}},redraw:function(t,e,n,i){if(null!=this._image){var s,r,a,o,h;this._doubledImage?(s=this._doubledImage,r=2*this._tileWidth,a=2*this._tileHeight,o=2*-this._offsetX,h=2*-this._offsetY,t*=2,e*=2,n*=2,i*=2):(s=this._image,r=this._tileWidth,a=this._tileHeight,o=-this._offsetX,h=-this._offsetY);var c=s.width/r|0,d=s.height/a|0,u=Math.max((t+o)/r|0,0),l=Math.max((e+h)/a|0,0),f=Math.ceil((t+o+n)/r),_=Math.ceil((e+h+i)/a),v=s._element,E=this._context;E.canvas;E.clearRect(t,e,n,i);for(var g=0,m=this._data.length;g<m;g++){var p=this._data[g],y=Math.min(f,p[0].length),C=Math.min(_,p.length);for(e=l;e<C;e++)for(t=u;t<y;t++){var T=p[e][t];if(0<=T&&T<c*d){var w=T%c*r,N=(T/c|0)*a;E.drawImage(v,w,N,r,a,t*r-o,e*a-h,r,a)}}}}},cvsRender:function(t){var e=o.Core.instance;if(0!==this.width&&0!==this.height){t.save(),t.setTransform(1,0,0,1,0,0);var n=this._context.canvas;t.drawImage(n,0,0,e.width,e.height),t.restore()}},domRender:function(t){this._image&&(this._style["background-image"]=this._surface._css,this._style[o.ENV.VENDOR_PREFIX+"Transform"]="matrix(1, 0, 0, 1, 0, 0)")}}),o.Group=o.Class.create(o.Node,{initialize:function(){this.childNodes=[],o.Node.call(this),this._rotation=0,this._scaleX=1,this._scaleY=1,this._originX=null,this._originY=null,this.__dirty=!1,[o.Event.ADDED_TO_SCENE,o.Event.REMOVED_FROM_SCENE].forEach((function(t){this.addEventListener(t,(function(t){this.childNodes.forEach((function(e){e.scene=this.scene,e.dispatchEvent(t)}),this)}))}),this)},addChild:function(t){t.parentNode&&t.parentNode.removeChild(t),this.childNodes.push(t),t.parentNode=this;var e=new o.Event("childadded");if(e.node=t,e.next=null,this.dispatchEvent(e),t.dispatchEvent(new o.Event("added")),this.scene){t.scene=this.scene;var n=new o.Event("addedtoscene");t.dispatchEvent(n)}},insertBefore:function(t,e){t.parentNode&&t.parentNode.removeChild(t);var n=this.childNodes.indexOf(e);if(-1!==n){this.childNodes.splice(n,0,t),t.parentNode=this;var i=new o.Event("childadded");if(i.node=t,i.next=e,this.dispatchEvent(i),t.dispatchEvent(new o.Event("added")),this.scene){t.scene=this.scene;var s=new o.Event("addedtoscene");t.dispatchEvent(s)}}else this.addChild(t)},removeChild:function(t){var e;if(-1!==(e=this.childNodes.indexOf(t))){this.childNodes.splice(e,1),t.parentNode=null;var n=new o.Event("childremoved");if(n.node=t,this.dispatchEvent(n),t.dispatchEvent(new o.Event("removed")),this.scene){t.scene=null;var i=new o.Event("removedfromscene");t.dispatchEvent(i)}}},firstChild:{get:function(){return this.childNodes[0]}},lastChild:{get:function(){return this.childNodes[this.childNodes.length-1]}},rotation:{get:function(){return this._rotation},set:function(t){this._rotation=t,this._dirty=!0}},scaleX:{get:function(){return this._scaleX},set:function(t){this._scaleX=t,this._dirty=!0}},scaleY:{get:function(){return this._scaleY},set:function(t){this._scaleY=t,this._dirty=!0}},originX:{get:function(){return this._originX},set:function(t){this._originX=t,this._dirty=!0}},originY:{get:function(){return this._originY},set:function(t){this._originY=t,this._dirty=!0}},_dirty:{get:function(){return this.__dirty},set:function(t){if(t=!!t,this.__dirty=t,t)for(var e=0,n=this.childNodes.length;e<n;e++)this.childNodes[e]._dirty=!0}}}),o.Matrix=o.Class.create({initialize:function(){this.reset()},reset:function(){this.stack=[],this.stack.push([1,0,0,1,0,0])},makeTransformMatrix:function(t,e){var n=t._x,i=t._y,s=t.width||0,r=t.height||0,a=t._rotation||0,o="number"==typeof t._scaleX?t._scaleX:1,h="number"==typeof t._scaleY?t._scaleY:1,c=a*Math.PI/180,d=Math.cos(c),u=Math.sin(c),l="number"==typeof t._originX?t._originX:s/2,f="number"==typeof t._originY?t._originY:r/2,_=o*d,v=o*u,E=h*u,g=h*d;e[0]=_,e[1]=v,e[2]=-E,e[3]=g,e[4]=-_*l+E*f+n+l,e[5]=-v*l-g*f+i+f},multiply:function(t,e,n){var i=t[0],s=t[2],r=t[4],a=t[1],o=t[3],h=t[5],c=e[0],d=e[2],u=e[4],l=e[1],f=e[3],_=e[5];n[0]=i*c+s*l,n[1]=a*c+o*l,n[2]=i*d+s*f,n[3]=a*d+o*f,n[4]=i*u+s*_+r,n[5]=a*u+o*_+h},multiplyVec:function(t,e,n){var i=e[0],s=e[1],r=t[0],a=t[2],o=t[4],h=t[1],c=t[3],d=t[5];n[0]=r*i+a*s+o,n[1]=h*i+c*s+d}}),o.Matrix.instance=new o.Matrix,o.DetectColorManager=o.Class.create({initialize:function(t,e){this.reference=[],this.colorResolution=t||16,this.max=e||1,this.capacity=Math.pow(this.colorResolution,3);for(var n=1,i=this.capacity;n<i;n++)this.reference[n]=null},attachDetectColor:function(t){var e=this.reference.indexOf(null);return-1===e&&(e=1),this.reference[e]=t,this._getColor(e)},detachDetectColor:function(t){var e=this.reference.indexOf(t);-1!==e&&(this.reference[e]=null)},_getColor:function(t){var e=this.colorResolution,n=e/this.max;return[parseInt(t/e/e%e,10)/n,parseInt(t/e%e,10)/n,parseInt(t%e,10)/n,1]},_decodeDetectColor:function(t){var e=this.colorResolution;return~~(t[0]*e*e*e/256)+~~(t[1]*e*e/256)+~~(t[2]*e/256)},getSpriteByColor:function(t){return this.reference[this._decodeDetectColor(t)]}}),o.DomManager=o.Class.create({initialize:function(t,e){var n=o.Core.instance;this.layer=null,this.targetNode=t,"string"==typeof e?this.element=document.createElement(e):e instanceof HTMLElement&&(this.element=e),this.style=this.element.style,this.style.position="absolute",this.style[o.ENV.VENDOR_PREFIX+"TransformOrigin"]="0px 0px",n._debug&&(this.style.border="1px solid blue",this.style.margin="-1px");var i=this;this._setDomTarget=function(){i.layer._touchEventTarget=i.targetNode},this._attachEvent()},getDomElement:function(){return this.element},getDomElementAsNext:function(){return this.element},getNextManager:function(t){var e=this.targetNode.parentNode.childNodes.indexOf(t.targetNode);return e!==this.targetNode.parentNode.childNodes.length-1?this.targetNode.parentNode.childNodes[e+1]._domManager:null},addManager:function(t,e){var n;e&&(n=e.getDomElementAsNext());var i=t.getDomElement();i instanceof Array?i.forEach((function(t){n?this.element.insertBefore(t,n):this.element.appendChild(t)}),this):n?this.element.insertBefore(i,n):this.element.appendChild(i),this.setLayer(this.layer)},removeManager:function(t){t instanceof o.DomlessManager?t._domRef.forEach((function(t){this.element.removeChild(t)}),this):this.element.removeChild(t.element),this.setLayer(this.layer)},setLayer:function(t){this.layer=t;var e,n=this.targetNode;if(n.childNodes)for(var i=0,s=n.childNodes.length;i<s;i++)(e=n.childNodes[i]._domManager)&&e.setLayer(t)},render:function(t){var e=this.targetNode,n=o.Matrix.instance,i=n.stack,s=[];n.makeTransformMatrix(e,s),n.multiply(i[i.length-1],s,s),n.multiply(t,s,t),e._matrix=t;var r="number"==typeof e._originX?e._originX:e.width/2||0,a="number"==typeof e._originY?e._originY:e.height/2||0,h=[r,a];n.multiplyVec(s,h,h),e._offsetX=h[0]-r,e._offsetY=h[1]-a,!e.parentNode||e.parentNode instanceof o.Group||(e._offsetX+=e.parentNode._offsetX,e._offsetY+=e.parentNode._offsetY),e._dirty&&(this.style[o.ENV.VENDOR_PREFIX+"Transform"]="matrix("+s[0].toFixed(10)+","+s[1].toFixed(10)+","+s[2].toFixed(10)+","+s[3].toFixed(10)+","+s[4].toFixed(10)+","+s[5].toFixed(10)+")"),this.domRender()},domRender:function(){var t,e=this.targetNode;for(var n in e._style||(e._style={}),e.__styleStatus||(e.__styleStatus={}),null!==e.width&&(e._style.width=e.width+"px"),null!==e.height&&(e._style.height=e.height+"px"),e._style.opacity=e._opacity,e._style["background-color"]=e._backgroundColor,void 0!==e._visible&&(e._style.display=e._visible?"block":"none"),"function"==typeof e.domRender&&e.domRender(this.element),e._style)t=e._style[n],e.__styleStatus[n]!==t&&null!=t&&(this.style.setProperty(n,""+t),e.__styleStatus[n]=t)},_attachEvent:function(){o.ENV.TOUCH_ENABLED&&this.element.addEventListener("touchstart",this._setDomTarget,!0),this.element.addEventListener("mousedown",this._setDomTarget,!0)},_detachEvent:function(){o.ENV.TOUCH_ENABLED&&this.element.removeEventListener("touchstart",this._setDomTarget,!0),this.element.removeEventListener("mousedown",this._setDomTarget,!0)},remove:function(){this._detachEvent(),this.element=this.style=this.targetNode=null}}),o.DomlessManager=o.Class.create({initialize:function(t){this._domRef=[],this.targetNode=t},_register:function(t,e){var n=this._domRef.indexOf(e);t instanceof Array?-1===n?Array.prototype.push.apply(this._domRef,t):Array.prototype.splice.apply(this._domRef,[n,0].concat(t)):-1===n?this._domRef.push(t):this._domRef.splice(n,0,t)},getNextManager:function(t){var e=this.targetNode.parentNode.childNodes.indexOf(t.targetNode);return e!==this.targetNode.parentNode.childNodes.length-1?this.targetNode.parentNode.childNodes[e+1]._domManager:null},getDomElement:function(){var t=[];return this.targetNode.childNodes.forEach((function(e){t=t.concat(e._domManager.getDomElement())})),t},getDomElementAsNext:function(){if(this._domRef.length)return this._domRef[0];var t=this.getNextManager(this);return t?t.element:null},addManager:function(t,e){var n=this.targetNode.parentNode;n&&(null===e&&(e=this.getNextManager(this)),n instanceof o.Scene?n._layers.Dom._domManager.addManager(t,e):n._domManager.addManager(t,e));var i=e?e.getDomElementAsNext():null;this._register(t.getDomElement(),i),this.setLayer(this.layer)},removeManager:function(t){var e,n=this._domRef.indexOf(t.element);-1!==n&&((e=this._domRef[n]).parentNode.removeChild(e),this._domRef.splice(n,1)),this.setLayer(this.layer)},setLayer:function(t){this.layer=t;var e,n=this.targetNode;if(n.childNodes)for(var i=0,s=n.childNodes.length;i<s;i++)(e=n.childNodes[i]._domManager)&&e.setLayer(t)},render:function(t){var e=o.Matrix.instance,n=e.stack,i=this.targetNode,s=[];e.makeTransformMatrix(i,s),e.multiply(n[n.length-1],s,s),e.multiply(t,s,t),i._matrix=t;var r="number"==typeof i._originX?i._originX:i.width/2||0,a="number"==typeof i._originY?i._originY:i.height/2||0,h=[r,a];e.multiplyVec(s,h,h),i._offsetX=h[0]-r,i._offsetY=h[1]-a,n.push(s)},remove:function(){this._domRef=[],this.targetNode=null}}),o.DomLayer=o.Class.create(o.Group,{initialize:function(){var t=o.Core.instance;o.Group.call(this),this._touchEventTarget=null,this._element=document.createElement("div"),this._element.style.position="absolute",this._domManager=new o.DomManager(this,this._element),this._domManager.layer=this,this.width=t.width,this.height=t.height,[o.Event.TOUCH_START,o.Event.TOUCH_MOVE,o.Event.TOUCH_END].forEach((function(t){this.addEventListener(t,(function(t){this._scene&&this._scene.dispatchEvent(t)}))}),this);var e=function(t){var i=t.node,s=t.next,r=t.target,a=s?s._domManager:null;o.DomLayer._attachDomManager(i,e,n),r._domManager.addManager(i._domManager,a);var h=new o.Event(o.Event.RENDER);i._dirty=!0,r._domManager.layer._rendering(i,h)},n=function(t){var i=t.node;t.target._domManager.removeManager(i._domManager),o.DomLayer._detachDomManager(i,e,n)};this.addEventListener("childremoved",n),this.addEventListener("childadded",e)},width:{get:function(){return this._width},set:function(t){this._width=t,this._element.style.width=t+"px"}},height:{get:function(){return this._height},set:function(t){this._height=t,this._element.style.height=t+"px"}},addChild:function(t){this.childNodes.push(t),t.parentNode=this;var e=new o.Event("childadded");if(e.node=t,e.next=null,this.dispatchEvent(e),t.dispatchEvent(new o.Event("added")),this.scene){t.scene=this.scene;var n=new o.Event("addedtoscene");t.dispatchEvent(n)}},insertBefore:function(t,e){var n=this.childNodes.indexOf(e);if(-1!==n){this.childNodes.splice(n,0,t),t.parentNode=this;var i=new o.Event("childadded");if(i.node=t,i.next=e,this.dispatchEvent(i),t.dispatchEvent(new o.Event("added")),this.scene){t.scene=this.scene;var s=new o.Event("addedtoscene");t.dispatchEvent(s)}}else this.addChild(t)},_startRendering:function(){this.addEventListener("exitframe",this._onexitframe),this._onexitframe()},_stopRendering:function(){this.removeEventListener("exitframe",this._onexitframe),this._onexitframe()},_onexitframe:function(){this._rendering(this,new o.Event(o.Event.RENDER))},_rendering:function(t,e,n){var i;if(n||(n=[1,0,0,1,0,0]),t.dispatchEvent(e),t._domManager.render(n),t.childNodes)for(var s=0,r=t.childNodes.length;s<r;s++)i=t.childNodes[s],this._rendering(i,e,n.slice());t._domManager instanceof o.DomlessManager&&o.Matrix.instance.stack.pop(),t._dirty=!1},_determineEventTarget:function(){var t=this._touchEventTarget;return this._touchEventTarget=null,t===this?null:t}}),o.DomLayer._attachDomManager=function(t,e,n){var i;if(t._domManager||(t.addEventListener("childadded",e),t.addEventListener("childremoved",n),t instanceof o.Group?t._domManager=new o.DomlessManager(t):t._element?t._domManager=new o.DomManager(t,t._element):t._domManager=new o.DomManager(t,"div")),t.childNodes)for(var s=0,r=t.childNodes.length;s<r;s++)i=t.childNodes[s],o.DomLayer._attachDomManager(i,e,n),t._domManager.addManager(i._domManager,null)},o.DomLayer._detachDomManager=function(t,e,n){var i;if(t.removeEventListener("childadded",e),t.removeEventListener("childremoved",n),t.childNodes)for(var s=0,r=t.childNodes.length;s<r;s++)i=t.childNodes[s],t._domManager.removeManager(i._domManager,null),o.DomLayer._detachDomManager(i,e,n);t._domManager.remove(),delete t._domManager},o.CanvasLayer=o.Class.create(o.Group,{initialize:function(){var t=o.Core.instance;o.Group.call(this),this._cvsCache={matrix:[1,0,0,1,0,0],detectColor:"#000000"},this._cvsCache.layer=this,this._element=document.createElement("canvas"),this._element.style.position="absolute",this._element.style.left=this._element.style.top="0px",this._detect=document.createElement("canvas"),this._detect.style.position="absolute",this._lastDetected=0,this.context=this._element.getContext("2d"),this._dctx=this._detect.getContext("2d"),this._colorManager=new o.DetectColorManager(16,256),this.width=t.width,this.height=t.height,[o.Event.TOUCH_START,o.Event.TOUCH_MOVE,o.Event.TOUCH_END].forEach((function(t){this.addEventListener(t,(function(t){this._scene&&this._scene.dispatchEvent(t)}))}),this);var e=function(t){var i,s=t.node,r=t.target;i=r instanceof o.CanvasLayer?r._scene._layers.Canvas:r.scene._layers.Canvas,o.CanvasLayer._attachCache(s,i,e,n);var a=new o.Event(o.Event.RENDER);r._dirty&&r._updateCoordinate(),s._dirty=!0,o.Matrix.instance.stack.push(r._matrix),o.CanvasRenderer.instance.render(i.context,s,a),o.Matrix.instance.stack.pop(r._matrix)},n=function(t){var i,s=t.node,r=t.target;i=r instanceof o.CanvasLayer?r._scene._layers.Canvas:r.scene._layers.Canvas,o.CanvasLayer._detachCache(s,i,e,n)};this.addEventListener("childremoved",n),this.addEventListener("childadded",e)},width:{get:function(){return this._width},set:function(t){this._width=t,this._element.width=this._detect.width=t}},height:{get:function(){return this._height},set:function(t){this._height=t,this._element.height=this._detect.height=t}},addChild:function(t){this.childNodes.push(t),t.parentNode=this;var e=new o.Event("childadded");if(e.node=t,e.next=null,this.dispatchEvent(e),t.dispatchEvent(new o.Event("added")),this.scene){t.scene=this.scene;var n=new o.Event("addedtoscene");t.dispatchEvent(n)}},insertBefore:function(t,e){var n=this.childNodes.indexOf(e);if(-1!==n){this.childNodes.splice(n,0,t),t.parentNode=this;var i=new o.Event("childadded");if(i.node=t,i.next=e,this.dispatchEvent(i),t.dispatchEvent(new o.Event("added")),this.scene){t.scene=this.scene;var s=new o.Event("addedtoscene");t.dispatchEvent(s)}}else this.addChild(t)},_startRendering:function(){this.addEventListener("exitframe",this._onexitframe),this._onexitframe(new o.Event(o.Event.RENDER))},_stopRendering:function(){this.removeEventListener("render",this._onexitframe),this._onexitframe(new o.Event(o.Event.RENDER))},_onexitframe:function(){var t=o.Core.instance,e=this.context;e.clearRect(0,0,t.width,t.height);var n=new o.Event(o.Event.RENDER);o.CanvasRenderer.instance.render(e,this,n)},_determineEventTarget:function(t){return this._getEntityByPosition(t.x,t.y)},_getEntityByPosition:function(t,e){var n=o.Core.instance,i=this._dctx;this._lastDetected<n.frame&&(i.clearRect(0,0,this.width,this.height),o.CanvasRenderer.instance.detectRender(i,this),this._lastDetected=n.frame);var s=i.getImageData(t,e,1,1).data;return this._colorManager.getSpriteByColor(s)}}),o.CanvasLayer._attachCache=function(t,e,n,i){var s;if(t._cvsCache||(t._cvsCache={},t._cvsCache.matrix=[1,0,0,1,0,0],t._cvsCache.detectColor="rgba("+e._colorManager.attachDetectColor(t)+")",t.addEventListener("childadded",n),t.addEventListener("childremoved",i)),t.childNodes)for(var r=0,a=t.childNodes.length;r<a;r++)s=t.childNodes[r],o.CanvasLayer._attachCache(s,e,n,i)},o.CanvasLayer._detachCache=function(t,e,n,i){var s;if(t._cvsCache&&(e._colorManager.detachDetectColor(t),t.removeEventListener("childadded",n),t.removeEventListener("childremoved",i),delete t._cvsCache),t.childNodes)for(var r=0,a=t.childNodes.length;r<a;r++)s=t.childNodes[r],o.CanvasLayer._detachCache(s,e,n,i)},o.CanvasRenderer=o.Class.create({render:function(t,e,n){var i,s,r;if(t.save(),e.dispatchEvent(n),this.transform(t,e),(void 0===e._visible||e._visible)&&(i=e.width,s=e.height,e.compositeOperation&&(t.globalCompositeOperation=e.compositeOperation),t.globalAlpha="number"==typeof e._opacity?e._opacity:1,e._backgroundColor&&(t.fillStyle=e._backgroundColor,t.fillRect(0,0,i,s)),e.cvsRender&&e.cvsRender(t),o.Core.instance._debug&&e._debugColor&&(t.strokeStyle=e._debugColor,t.strokeRect(0,0,i,s)),e._clipping&&(t.beginPath(),t.rect(0,0,i,s),t.clip()),e.childNodes))for(var a=0,h=e.childNodes.length;a<h;a++)r=e.childNodes[a],this.render(t,r,n);t.restore(),o.Matrix.instance.stack.pop()},detectRender:function(t,e){var n,i,s;if(void 0===e._visible||e._visible){if(n=e.width,i=e.height,t.save(),this.transform(t,e),t.fillStyle=e._cvsCache.detectColor,e._touchEnabled&&(e.detectRender?e.detectRender(t):t.fillRect(0,0,n,i)),e._clipping&&(t.beginPath(),t.rect(0,0,n,i),t.clip()),e.childNodes)for(var r=0,a=e.childNodes.length;r<a;r++)s=e.childNodes[r],this.detectRender(t,s);t.restore(),o.Matrix.instance.stack.pop()}},transform:function(t,e){var n,i,s,r,a=o.Matrix.instance,h=a.stack;e._dirty?(a.makeTransformMatrix(e,e._cvsCache.matrix),n=[],a.multiply(h[h.length-1],e._cvsCache.matrix,n),e._matrix=n,r=[i="number"==typeof e._originX?e._originX:e._width/2||0,s="number"==typeof e._originY?e._originY:e._height/2||0],a.multiplyVec(n,r,r),e._offsetX=r[0]-i,e._offsetY=r[1]-s,e._dirty=!1):n=e._matrix,h.push(n),t.setTransform.apply(t,n)}}),o.CanvasRenderer.instance=new o.CanvasRenderer,o.Scene=o.Class.create(o.Group,{initialize:function(){var t=o.Core.instance;o.Group.call(this),this.scene=this,this._backgroundColor=null,this._element=document.createElement("div"),this._element.style.position="absolute",this._element.style.overflow="hidden",this._element.style[o.ENV.VENDOR_PREFIX+"TransformOrigin"]="0 0",this._layers={},this._layerPriority=[],this.addEventListener(o.Event.CHILD_ADDED,this._onchildadded),this.addEventListener(o.Event.CHILD_REMOVED,this._onchildremoved),this.addEventListener(o.Event.ENTER,this._onenter),this.addEventListener(o.Event.EXIT,this._onexit);var e=this;this._dispatchExitframe=function(){for(var t in e._layers)e._layers[t].dispatchEvent(new o.Event(o.Event.EXIT_FRAME))},this.addEventListener(o.Event.CORE_RESIZE,this._oncoreresize),this._oncoreresize(t)},x:{get:function(){return this._x},set:function(t){for(var e in this._x=t,this._layers)this._layers[e].x=t}},y:{get:function(){return this._y},set:function(t){for(var e in this._y=t,this._layers)this._layers[e].y=t}},width:{get:function(){return this._width},set:function(t){for(var e in this._width=t,this._layers)this._layers[e].width=t}},height:{get:function(){return this._height},set:function(t){for(var e in this._height=t,this._layers)this._layers[e].height=t}},rotation:{get:function(){return this._rotation},set:function(t){for(var e in this._rotation=t,this._layers)this._layers[e].rotation=t}},scaleX:{get:function(){return this._scaleX},set:function(t){for(var e in this._scaleX=t,this._layers)this._layers[e].scaleX=t}},scaleY:{get:function(){return this._scaleY},set:function(t){for(var e in this._scaleY=t,this._layers)this._layers[e].scaleY=t}},backgroundColor:{get:function(){return this._backgroundColor},set:function(t){this._backgroundColor=this._element.style.backgroundColor=t}},_oncoreresize:function(t){for(var e in this._element.style.width=t.width+"px",this.width=t.width,this._element.style.height=t.height+"px",this.height=t.height,this._element.style[o.ENV.VENDOR_PREFIX+"Transform"]="scale("+t.scale+")",this._layers)this._layers[e].dispatchEvent(t)},addLayer:function(t,e){var n=o.Core.instance;if(!this._layers[t]){var i=new o[t+"Layer"];n.currentScene===this&&i._startRendering(),this._layers[t]=i;var s=i._element;if("number"==typeof e){var r=this._element.childNodes[e];r?this._element.insertBefore(s,r):this._element.appendChild(s),this._layerPriority.splice(e,0,t)}else this._element.appendChild(s),this._layerPriority.push(t);i._scene=this}},_determineEventTarget:function(t){for(var e,n=this._layerPriority.length-1;n>=0&&!(e=this._layers[this._layerPriority[n]]._determineEventTarget(t));n--);return e||(e=this),e},_onchildadded:function(t){var e,n,i=t.node,s=t.next;i._element?(e="Dom",n=1):(e="Canvas",n=0),this._layers[e]||this.addLayer(e,n),i._layer=this._layers[e],this._layers[e].insertBefore(i,s),i.parentNode=this},_onchildremoved:function(t){var e=t.node;e._layer.removeChild(e),e._layer=null},_onenter:function(){for(var t in this._layers)this._layers[t]._startRendering();o.Core.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){for(var t in this._layers)this._layers[t]._stopRendering();o.Core.instance.removeEventListener("exitframe",this._dispatchExitframe)}}),o.LoadingScene=o.Class.create(o.Scene,{initialize:function(){o.Scene.call(this),this.backgroundColor="#000";var t=.4*this.width|0,e=.05*this.width|0,n=.03*t|0,i=new o.Sprite(t,e);i.disableCollection(),i.x=(this.width-t)/2,i.y=(this.height-e)/2;var s=new o.Surface(t,e);s.context.fillStyle="#fff",s.context.fillRect(0,0,t,e),s.context.fillStyle="#000",s.context.fillRect(n,n,t-2*n,e-2*n),i.image=s;var r=0,a=0;this.addEventListener("progress",(function(t){r=t.loaded/t.total*1})),i.addEventListener("enterframe",(function(){a*=.9,a+=.1*r,s.context.fillStyle="#fff",s.context.fillRect(n,0,(t-2*n)*a,e)})),this.addChild(i),this.addEventListener("load",(function(t){var e=o.Core.instance;e.removeScene(e.loadingScene),e.dispatchEvent(t)}))}}),o.CanvasScene=o.Class.create(o.Scene,{initialize:function(){o.Scene.call(this),this.addLayer("Canvas")},_determineEventTarget:function(t){var e=this._layers.Canvas._determineEventTarget(t);return e||(e=this),e},_onchildadded:function(t){var e=t.node,n=t.next;e._layer=this._layers.Canvas,this._layers.Canvas.insertBefore(e,n)},_onenter:function(){this._layers.Canvas._startRendering(),o.Core.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){this._layers.Canvas._stopRendering(),o.Core.instance.removeEventListener("exitframe",this._dispatchExitframe)}}),o.DOMScene=o.Class.create(o.Scene,{initialize:function(){o.Scene.call(this),this.addLayer("Dom")},_determineEventTarget:function(t){var e=this._layers.Dom._determineEventTarget(t);return e||(e=this),e},_onchildadded:function(t){var e=t.node,n=t.next;e._layer=this._layers.Dom,this._layers.Dom.insertBefore(e,n)},_onenter:function(){this._layers.Dom._startRendering(),o.Core.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){this._layers.Dom._stopRendering(),o.Core.instance.removeEventListener("exitframe",this._dispatchExitframe)}}),o.Surface=o.Class.create(o.EventTarget,{initialize:function(t,e){o.EventTarget.call(this);var n=o.Core.instance;this.width=t,this.height=e,this.context=null;var i="enchant-surface"+n._surfaceID++;if(document.getCSSCanvasContext){this.context=document.getCSSCanvasContext("2d",i,t,e),this._element=this.context.canvas,this._css="-webkit-canvas("+i+")";this.context}else document.mozSetImageElement?(this._element=document.createElement("canvas"),this._element.width=t,this._element.height=e,this._css="-moz-element(#"+i+")",this.context=this._element.getContext("2d"),document.mozSetImageElement(i,this._element)):(this._element=document.createElement("canvas"),this._element.width=t,this._element.height=e,this._element.style.position="absolute",this.context=this._element.getContext("2d"),o.ENV.CANVAS_DRAWING_METHODS.forEach((function(t){var e=this.context[t];this.context[t]=function(){e.apply(this,arguments),this._dirty=!0}}),this))},getPixel:function(t,e){return this.context.getImageData(t,e,1,1).data},setPixel:function(t,e,n,i,s,r){var a=this.context.createImageData(1,1);a.data[0]=n,a.data[1]=i,a.data[2]=s,a.data[3]=r,this.context.putImageData(a,t,e)},clear:function(){this.context.clearRect(0,0,this.width,this.height)},draw:function(t){if(t=t._element,1===arguments.length)this.context.drawImage(t,0,0);else{var e=arguments;e[0]=t,this.context.drawImage.apply(this.context,e)}},clone:function(){var t=new o.Surface(this.width,this.height);return t.draw(this),t},toDataURL:function(){var t=this._element.src;return t?"data:"===t.slice(0,5)?t:this.clone().toDataURL():this._element.toDataURL()}}),o.Surface.load=function(t,e,n){var i=new Image,s=Object.create(o.Surface.prototype,{context:{value:null},_css:{value:"url("+t+")"},_element:{value:i}});return o.EventTarget.call(s),n=n||function(){},s.addEventListener("load",e),s.addEventListener("error",n),i.onerror=function(){var t=new o.Event(o.Event.ERROR);t.message="Cannot load an asset: "+i.src,o.Core.instance.dispatchEvent(t),s.dispatchEvent(t)},i.onload=function(){s.width=i.width,s.height=i.height,s.dispatchEvent(new o.Event("load"))},i.src=t,s},o.Surface._staticCanvas2DContext=document.createElement("canvas").getContext("2d"),o.Surface._getPattern=function(t,e){return t._pattern&&!e||(t._pattern=this._staticCanvas2DContext.createPattern(t._element,"repeat")),t._pattern},t.Deferred?o.Deferred=t.Deferred:(o.Deferred=o.Class.create({initialize:function(){this._succ=this._fail=this._next=this._id=null,this._tail=this},next:function(t){var e=new o.Deferred;return e._succ=t,this._add(e)},error:function(t){var e=new o.Deferred;return e._fail=t,this._add(e)},_add:function(t){return this._tail._next=t,this._tail=t,this},call:function(t){for(var e,n=this;n&&!n._succ;)n=n._next;if(n instanceof o.Deferred){try{e=n._succ(t)}catch(t){return n.fail(t)}e instanceof o.Deferred?o.Deferred._insert(n,e):n._next instanceof o.Deferred&&n._next.call(e)}},fail:function(t){for(var e,n,i=this;i&&!i._fail;)i=i._next;if(!(i instanceof o.Deferred))throw t instanceof Error?t:((n=new Error("failed in Deferred")).arg=t,n);e=i._fail(t),i.call(e)}}),o.Deferred._insert=function(t,e){t._next instanceof o.Deferred&&(e._tail._next=t._next),t._next=e},o.Deferred.next=function(t){var e=(new o.Deferred).next(t);return e._id=setTimeout((function(){e.call()}),0),e},o.Deferred.parallel=function(t){var e=new o.Deferred;e._id=setTimeout((function(){e.call()}),0);var n=0,i=t instanceof Array?[]:{},s=new o.Deferred;for(var r in t)t.hasOwnProperty(r)&&(n++,function(t,e){t.next((function(t){n--,i[e]=t,n<=0&&s.call(i)})).error((function(t){s.fail(t)})),"number"==typeof t._id&&clearTimeout(t._id),t._id=setTimeout((function(){t.call()}),0)}(t[r],r));return n||(s._id=setTimeout((function(){s.call(i)}),0)),e.next((function(){return s}))}),o.DOMSound=o.Class.create(o.EventTarget,{initialize:function(){throw o.EventTarget.call(this),this.duration=0,new Error("Illegal Constructor")},play:function(){this._element&&this._element.play()},pause:function(){this._element&&this._element.pause()},stop:function(){this.pause(),this.currentTime=0},clone:function(){var t;if(this._element instanceof Audio)t=Object.create(o.DOMSound.prototype,{_element:{value:this._element.cloneNode(!1)},duration:{value:this.duration}});else{if(o.ENV.USE_FLASH_SOUND)return this;t=Object.create(o.DOMSound.prototype)}return o.EventTarget.call(t),t},currentTime:{get:function(){return this._element?this._element.currentTime:0},set:function(t){this._element&&(this._element.currentTime=t)}},volume:{get:function(){return this._element?this._element.volume:1},set:function(t){this._element&&(this._element.volume=t)}}}),o.DOMSound.load=function(e,n,i,s){if(null==n){var r=o.Core.findExt(e);n=r?"audio/"+r:""}n=n.replace("mp3","mpeg").replace("m4a","mp4"),i=i||function(){},s=s||function(){};var a=Object.create(o.DOMSound.prototype);o.EventTarget.call(a),a.addEventListener("load",i),a.addEventListener("error",s);var h=new Audio;if(!o.ENV.SOUND_ENABLED_ON_MOBILE_SAFARI&&"webkit"===o.ENV.VENDOR_PREFIX&&o.ENV.TOUCH_ENABLED)t.setTimeout((function(){a.dispatchEvent(new o.Event("load"))}),0);else if(!o.ENV.USE_FLASH_SOUND&&h.canPlayType(n))h.addEventListener("canplaythrough",(function t(){a.duration=h.duration,a.dispatchEvent(new o.Event("load")),h.removeEventListener("canplaythrough",t)}),!1),h.src=e,h.load(),h.autoplay=!1,h.onerror=function(){var t=new o.Event(o.Event.ERROR);t.message="Cannot load an asset: "+h.src,o.Core.instance.dispatchEvent(t),a.dispatchEvent(t)},a._element=h;else if("audio/mpeg"===n){var c=document.createElement("embed"),d="enchant-audio"+o.Core.instance._soundID++;c.width=c.height=1,c.name=d,c.src="sound.swf?id="+d+"&src="+e,c.allowscriptaccess="always",c.style.position="absolute",c.style.left="-1px",a.addEventListener("load",(function(){Object.defineProperties(c,{currentTime:{get:function(){return c.getCurrentTime()},set:function(t){c.setCurrentTime(t)}},volume:{get:function(){return c.getVolume()},set:function(t){c.setVolume(t)}}}),a._element=c,a.duration=c.getDuration()})),o.Core.instance._element.appendChild(c),o.DOMSound[d]=a}else t.setTimeout((function(){a.dispatchEvent(new o.Event("load"))}),0);return a},t.AudioContext=t.AudioContext||t.webkitAudioContext||t.mozAudioContext||t.msAudioContext||t.oAudioContext,o.WebAudioSound=o.Class.create(o.EventTarget,{initialize:function(){if(!t.AudioContext)throw new Error("This browser does not support WebAudio API.");o.EventTarget.call(this),this.context=o.WebAudioSound.audioContext,this.src=this.context.createBufferSource(),this.buffer=null,this._volume=1,this._currentTime=0,this._state=0,this.connectTarget=o.WebAudioSound.destination},play:function(t){1!==this._state||t||this.src.disconnect(this.connectTarget),2!==this._state&&(this._currentTime=0);var e=this._currentTime,n=this.context;this.src=n.createBufferSource(),null!=n.createGain?this._gain=n.createGain():this._gain=n.createGainNode(),this.src.buffer=this.buffer,this._gain.gain.value=this._volume,this.src.connect(this._gain),this._gain.connect(this.connectTarget),null!=this.src.start?this.src.start(0,e,this.buffer.duration-e-1.192e-7):this.src.noteGrainOn(0,e,this.buffer.duration-e-1.192e-7),this._startTime=n.currentTime-this._currentTime,this._state=1},pause:function(){var t=this.currentTime;t!==this.duration&&(null!=this.src.stop?this.src.stop(0):this.src.noteOff(0),this._currentTime=t,this._state=2)},stop:function(){null!=this.src.stop?this.src.stop(0):this.src.noteOff(0),this._state=0},clone:function(){var t=new o.WebAudioSound;return t.buffer=this.buffer,t},duration:{get:function(){return this.buffer?this.buffer.duration:0}},volume:{get:function(){return this._volume},set:function(t){t=Math.max(0,Math.min(1,t)),this._volume=t,this.src&&(this._gain.gain.value=t)}},currentTime:{get:function(){return Math.max(0,Math.min(this.duration,this.src.context.currentTime-this._startTime))},set:function(t){this._currentTime=t,2!==this._state&&this.play(!1)}}}),o.WebAudioSound.load=function(t,e,n,i){var s,r,a=(new Audio).canPlayType(e),h=new o.WebAudioSound;function c(){var e=new o.Event(o.Event.ERROR);e.message="Cannot load an asset: "+t,o.Core.instance.dispatchEvent(e),h.dispatchEvent(e)}return n=n||function(){},i=i||function(){},h.addEventListener(o.Event.LOAD,n),h.addEventListener(o.Event.ERROR,i),"maybe"===a||"probably"===a?(s=o.WebAudioSound.audioContext,(r=new XMLHttpRequest).open("GET",t,!0),r.responseType="arraybuffer",r.onload=function(){s.decodeAudioData(r.response,(function(t){h.buffer=t,h.dispatchEvent(new o.Event(o.Event.LOAD))}),c)},r.onerror=c,r.send(null)):setTimeout(c,50),h},t.AudioContext&&(o.WebAudioSound.audioContext=new t.AudioContext,o.WebAudioSound.destination=o.WebAudioSound.audioContext.destination),o.Sound=t.AudioContext&&o.ENV.USE_WEBAUDIO?o.WebAudioSound:o.DOMSound,o.Easing={LINEAR:function(t,e,n,i){return n*t/i+e},SWING:function(t,e,n,i){return n*(.5-Math.cos(t/i*Math.PI)/2)+e},QUAD_EASEIN:function(t,e,n,i){return n*(t/=i)*t+e},QUAD_EASEOUT:function(t,e,n,i){return-n*(t/=i)*(t-2)+e},QUAD_EASEINOUT:function(t,e,n,i){return(t/=i/2)<1?n/2*t*t+e:-n/2*(--t*(t-2)-1)+e},CUBIC_EASEIN:function(t,e,n,i){return n*(t/=i)*t*t+e},CUBIC_EASEOUT:function(t,e,n,i){return n*((t=t/i-1)*t*t+1)+e},CUBIC_EASEINOUT:function(t,e,n,i){return(t/=i/2)<1?n/2*t*t*t+e:n/2*((t-=2)*t*t+2)+e},QUART_EASEIN:function(t,e,n,i){return n*(t/=i)*t*t*t+e},QUART_EASEOUT:function(t,e,n,i){return-n*((t=t/i-1)*t*t*t-1)+e},QUART_EASEINOUT:function(t,e,n,i){return(t/=i/2)<1?n/2*t*t*t*t+e:-n/2*((t-=2)*t*t*t-2)+e},QUINT_EASEIN:function(t,e,n,i){return n*(t/=i)*t*t*t*t+e},QUINT_EASEOUT:function(t,e,n,i){return n*((t=t/i-1)*t*t*t*t+1)+e},QUINT_EASEINOUT:function(t,e,n,i){return(t/=i/2)<1?n/2*t*t*t*t*t+e:n/2*((t-=2)*t*t*t*t+2)+e},SIN_EASEIN:function(t,e,n,i){return-n*Math.cos(t/i*(Math.PI/2))+n+e},SIN_EASEOUT:function(t,e,n,i){return n*Math.sin(t/i*(Math.PI/2))+e},SIN_EASEINOUT:function(t,e,n,i){return-n/2*(Math.cos(Math.PI*t/i)-1)+e},CIRC_EASEIN:function(t,e,n,i){return-n*(Math.sqrt(1-(t/=i)*t)-1)+e},CIRC_EASEOUT:function(t,e,n,i){return n*Math.sqrt(1-(t=t/i-1)*t)+e},CIRC_EASEINOUT:function(t,e,n,i){return(t/=i/2)<1?-n/2*(Math.sqrt(1-t*t)-1)+e:n/2*(Math.sqrt(1-(t-=2)*t)+1)+e},ELASTIC_EASEIN:function(t,e,n,i,s,r){return 0===t?e:1==(t/=i)?e+n:(r||(r=.3*i),!s||s<Math.abs(n)?(s=n,a=r/4):a=r/(2*Math.PI)*Math.asin(n/s),-s*Math.pow(2,10*(t-=1))*Math.sin((t*i-a)*(2*Math.PI)/r)+e);var a},ELASTIC_EASEOUT:function(t,e,n,i,s,r){return 0===t?e:1==(t/=i)?e+n:(r||(r=.3*i),!s||s<Math.abs(n)?(s=n,a=r/4):a=r/(2*Math.PI)*Math.asin(n/s),s*Math.pow(2,-10*t)*Math.sin((t*i-a)*(2*Math.PI)/r)+n+e);var a},ELASTIC_EASEINOUT:function(t,e,n,i,s,r){return 0===t?e:2==(t/=i/2)?e+n:(r||(r=i*(.3*1.5)),!s||s<Math.abs(n)?(s=n,a=r/4):a=r/(2*Math.PI)*Math.asin(n/s),t<1?s*Math.pow(2,10*(t-=1))*Math.sin((t*i-a)*(2*Math.PI)/r)*-.5+e:s*Math.pow(2,-10*(t-=1))*Math.sin((t*i-a)*(2*Math.PI)/r)*.5+n+e);var a},BOUNCE_EASEOUT:function(t,e,n,i){return(t/=i)<1/2.75?n*(7.5625*t*t)+e:t<2/2.75?n*(7.5625*(t-=1.5/2.75)*t+.75)+e:t<2.5/2.75?n*(7.5625*(t-=2.25/2.75)*t+.9375)+e:n*(7.5625*(t-=2.625/2.75)*t+.984375)+e},BOUNCE_EASEIN:function(t,e,n,i){return n-o.Easing.BOUNCE_EASEOUT(i-t,0,n,i)+e},BOUNCE_EASEINOUT:function(t,e,n,i){return t<i/2?.5*o.Easing.BOUNCE_EASEIN(2*t,0,n,i)+e:.5*o.Easing.BOUNCE_EASEOUT(2*t-i,0,n,i)+.5*n+e},BACK_EASEIN:function(t,n,i,s,r){return r===e&&(r=1.70158),i*(t/=s)*t*((r+1)*t-r)+n},BACK_EASEOUT:function(t,n,i,s,r){return r===e&&(r=1.70158),i*((t=t/s-1)*t*((r+1)*t+r)+1)+n},BACK_EASEINOUT:function(t,n,i,s,r){return r===e&&(r=1.70158),(t/=s/2)<1?i/2*(t*t*((1+(r*=1.525))*t-r))+n:i/2*((t-=2)*t*((1+(r*=1.525))*t+r)+2)+n},EXPO_EASEIN:function(t,e,n,i){return 0===t?e:n*Math.pow(2,10*(t/i-1))+e},EXPO_EASEOUT:function(t,e,n,i){return t===i?e+n:n*(1-Math.pow(2,-10*t/i))+e},EXPO_EASEINOUT:function(t,e,n,i){return 0===t?e:t===i?e+n:(t/=i/2)<1?n/2*Math.pow(2,10*(t-1))+e:n/2*(2-Math.pow(2,-10*--t))+e}},o.ActionEventTarget=o.Class.create(o.EventTarget,{initialize:function(){o.EventTarget.apply(this,arguments)},dispatchEvent:function(t){var e;this.node?(e=this.node,t.target=e,t.localX=t.x-e._offsetX,t.localY=t.y-e._offsetY):this.node=null,null!=this["on"+t.type]&&this["on"+t.type].call(e,t);var n=this._listeners[t.type];if(null!=n)for(var i=0,s=(n=n.slice()).length;i<s;i++)n[i].call(e,t)}}),o.Timeline=o.Class.create(o.EventTarget,{initialize:function(t){o.EventTarget.call(this),this.node=t,this.queue=[],this.paused=!1,this.looped=!1,this.isFrameBased=!0,this._parallel=null,this._activated=!1,this.addEventListener(o.Event.ENTER_FRAME,this.tick)},_deactivateTimeline:function(){this._activated&&(this._activated=!1,this.node.removeEventListener("enterframe",this._nodeEventListener))},_activateTimeline:function(){this._activated||this.paused||(this.node.addEventListener("enterframe",this._nodeEventListener),this._activated=!0)},setFrameBased:function(){this.isFrameBased=!0},setTimeBased:function(){this.isFrameBased=!1},next:function(t){var e,n=this.queue.shift();if(n&&((e=new o.Event("actionend")).timeline=this,n.dispatchEvent(e)),0===this.queue.length)return this._activated=!1,void this.node.removeEventListener("enterframe",this._nodeEventListener);if(this.looped?((e=new o.Event("removedfromtimeline")).timeline=this,n.dispatchEvent(e),n.frame=0,this.add(n)):((e=new o.Event("removedfromtimeline")).timeline=this,n.dispatchEvent(e)),t>0||this.queue[0]&&0===this.queue[0].time){var i=new o.Event("enterframe");i.elapsed=t,this.dispatchEvent(i)}},tick:function(t){if(!this.paused&&this.queue.length>0){var e,n=this.queue[0];if(0===n.frame)(e=new o.Event("actionstart")).timeline=this,n.dispatchEvent(e);var i=new o.Event("actiontick");i.timeline=this,this.isFrameBased?i.elapsed=1:i.elapsed=t.elapsed,n.dispatchEvent(i)}},add:function(t){if(!this._activated){var e=this;this._nodeEventListener=function(t){e.dispatchEvent(t)},this.node.addEventListener("enterframe",this._nodeEventListener),this._activated=!0}this._parallel?(this._parallel.actions.push(t),this._parallel=null):this.queue.push(t),t.frame=0;var n=new o.Event("addedtotimeline");return n.timeline=this,t.dispatchEvent(n),(n=new o.Event("actionadded")).action=t,this.dispatchEvent(n),this},action:function(t){return this.add(new o.Action(t))},tween:function(t){return this.add(new o.Tween(t))},clear:function(){var t=new o.Event("removedfromtimeline");t.timeline=this;for(var e=0,n=this.queue.length;e<n;e++)this.queue[e].dispatchEvent(t);return this.queue=[],this._deactivateTimeline(),this},skip:function(t){var e=new o.Event("enterframe");for(this.isFrameBased?e.elapsed=1:(e.elapsed=t,t=1);t--;)this.dispatchEvent(e);return this},pause:function(){return this.paused||(this.paused=!0,this._deactivateTimeline()),this},resume:function(){return this.paused&&(this.paused=!1,this._activateTimeline()),this},loop:function(){return this.looped=!0,this},unloop:function(){return this.looped=!1,this},delay:function(t){return this.add(new o.Action({time:t})),this},wait:function(t){return this},then:function(t){var e=this;return this.add(new o.Action({onactiontick:function(n){t.call(e.node)},time:0})),this},exec:function(t){this.then(t)},cue:function(t){var e=0;for(var n in t)t.hasOwnProperty(n)&&(this.delay(n-e),this.then(t[n]),e=n)},repeat:function(t,e){return this.add(new o.Action({onactiontick:function(e){t.call(this)},time:e})),this},and:function(){var t=this.queue.pop();if(t instanceof o.ParallelAction)this._parallel=t,this.queue.push(t);else{var e=new o.ParallelAction;e.actions.push(t),this.queue.push(e),this._parallel=e}return this},or:function(){return this},doAll:function(t){return this},waitAll:function(){return this},waitUntil:function(t){var e=this;return this.add(new o.Action({onactionstart:t,onactiontick:function(n){t.call(this)&&e.next()}})),this},fadeTo:function(t,e,n){return this.tween({opacity:t,time:e,easing:n}),this},fadeIn:function(t,e){return this.fadeTo(1,t,e)},fadeOut:function(t,e){return this.fadeTo(0,t,e)},moveTo:function(t,e,n,i){return this.tween({x:t,y:e,time:n,easing:i})},moveX:function(t,e,n){return this.tween({x:t,time:e,easing:n})},moveY:function(t,e,n){return this.tween({y:t,time:e,easing:n})},moveBy:function(t,e,n,i){return this.tween({x:function(){return this.x+t},y:function(){return this.y+e},time:n,easing:i})},hide:function(){return this.then((function(){this.opacity=0}))},show:function(){return this.then((function(){this.opacity=1}))},removeFromScene:function(){return this.then((function(){this.scene.removeChild(this)}))},scaleTo:function(t,e,n){return"number"==typeof n?this.tween({scaleX:arguments[0],scaleY:arguments[1],time:arguments[2],easing:arguments[3]}):this.tween({scaleX:t,scaleY:t,time:e,easing:n})},scaleBy:function(t,e,n){return"number"==typeof n?this.tween({scaleX:function(){return this.scaleX*arguments[0]},scaleY:function(){return this.scaleY*arguments[1]},time:arguments[2],easing:arguments[3]}):this.tween({scaleX:function(){return this.scaleX*t},scaleY:function(){return this.scaleY*t},time:e,easing:n})},rotateTo:function(t,e,n){return this.tween({rotation:t,time:e,easing:n})},rotateBy:function(t,e,n){return this.tween({rotation:function(){return this.rotation+t},time:e,easing:n})}}),o.Action=o.Class.create(o.ActionEventTarget,{initialize:function(t){for(var e in o.ActionEventTarget.call(this),this.time=null,this.frame=0,t)t.hasOwnProperty(e)&&null!=t[e]&&(this[e]=t[e]);var n=this;this.timeline=null,this.node=null,this.addEventListener(o.Event.ADDED_TO_TIMELINE,(function(t){n.timeline=t.timeline,n.node=t.timeline.node,n.frame=0})),this.addEventListener(o.Event.REMOVED_FROM_TIMELINE,(function(){n.timeline=null,n.node=null,n.frame=0})),this.addEventListener(o.Event.ACTION_TICK,(function(t){var e=n.time-(n.frame+t.elapsed);null!=n.time&&e<=0?(n.frame=n.time,t.timeline.next(-e)):n.frame+=t.elapsed}))}}),o.ParallelAction=o.Class.create(o.Action,{initialize:function(t){o.Action.call(this,t);this.timeline,this.node;this.actions=[],this.endedActions=[];var e=this;this.addEventListener(o.Event.ACTION_START,(function(t){for(var n=0,i=e.actions.length;n<i;n++)e.actions[n].dispatchEvent(t)})),this.addEventListener(o.Event.ACTION_TICK,(function(t){var n,i,s={next:function(t){var s=e.actions[n];e.actions.splice(n--,1),i=e.actions.length,e.endedActions.push(s);var r=new o.Event("actionend");r.timeline=this,s.dispatchEvent(r),(r=new o.Event("removedfromtimeline")).timeline=this,s.dispatchEvent(r)}},r=new o.Event("actiontick");for(r.timeline=s,r.elapsed=t.elapsed,n=0,i=e.actions.length;n<i;n++)e.actions[n].dispatchEvent(r);0===e.actions.length&&t.timeline.next()})),this.addEventListener(o.Event.ADDED_TO_TIMELINE,(function(t){for(var n=0,i=e.actions.length;n<i;n++)e.actions[n].dispatchEvent(t)})),this.addEventListener(o.Event.REMOVED_FROM_TIMELINE,(function(){this.actions=this.endedActions,this.endedActions=[]}))}}),o.Tween=o.Class.create(o.Action,{initialize:function(t){var e={},n={};o.Action.call(this,t),null==this.easing&&(this.easing=function(t,e,n,i){return n*t/i+e});var i=this;this.addEventListener(o.Event.ACTION_START,(function(){var s=["frame","time","callback","onactiontick","onactionstart","onactionend"];for(var r in t){var a;if(t.hasOwnProperty(r))a="function"==typeof t[r]?t[r].call(i.node):t[r],-1===s.indexOf(r)&&(e[r]=i.node[r],n[r]=a)}})),this.addEventListener(o.Event.ACTION_TICK,(function(t){var s=0===i.time?1:i.easing(Math.min(i.time,i.frame+t.elapsed),0,1,i.time)-i.easing(i.frame,0,1,i.time);for(var r in n)if(n.hasOwnProperty(r)){if(void 0===this[r])continue;i.node[r]+=(n[r]-e[r])*s,Math.abs(i.node[r])<1e-7&&(i.node[r]=0)}}))}})}(window);
  </script>
    <script>enchant(),enchant.ENV.TOUCH_ENABLED=function(){var e=document.createElement("div");return e.addEventListener("touchstart",(function(e){}),{passive:!0}),"function"==typeof e.ontouchstart}(),enchant.ENV.USE_TOUCH_TO_START_SCENE=!1;var minus,plus,roll_btn,game=null,STAGE_WIDTH=640,STAGE_HEIGHT=640,shadow_scale=.9;shadows=[],dices=[];var DICE_IMG,MINUS_IMG,PLUS_IMG,ROLL_IMG,KAGE_IMG,img=new Image;img.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",img.onload=function(){},window.onload=function(){centeringBody(),(game=new Game(STAGE_WIDTH,STAGE_HEIGHT)).fps=24,img.width?(DICE_IMG="img/alldicetouka.webp",MINUS_IMG="img/minus-btn.webp",PLUS_IMG="img/plus-btn.webp",ROLL_IMG="img/roll-btn.webp",KAGE_IMG="img/kage.webp"):(DICE_IMG="img/alldicetouka.png",MINUS_IMG="img/minus-btn.png",PLUS_IMG="img/plus-btn.png",ROLL_IMG="img/roll-btn.png",KAGE_IMG="img/kage.png"),game.preload(DICE_IMG,MINUS_IMG,PLUS_IMG,ROLL_IMG,KAGE_IMG),game.onload=function(){var e=1,i=new Sprite(STAGE_WIDTH,STAGE_HEIGHT),s=new Surface(STAGE_WIDTH,STAGE_HEIGHT);s.fillGradient(0,0,STAGE_WIDTH,STAGE_HEIGHT,"#1dd132","#10771c"),i.image=s,game.rootScene.addChild(i),dices_pos=[{x:STAGE_WIDTH/2-140,y:96},{x:STAGE_WIDTH/2-140-140,y:174},{x:STAGE_WIDTH/2-140+140,y:174},{x:STAGE_WIDTH/2-140,y:262}];for(var n=0;n<4;n++){var t=new Shadow(256,256);t.scale(shadow_scale),t.x=dices_pos[n].x,t.y=dices_pos[n].y,t.visible=!1,game.rootScene.addChild(t),shadows.push(t)}for(n=0;n<4;n++){var a=new Dice(256,256);a.x=dices_pos[n].x,a.y=dices_pos[n].y,a.tick=0,a.visible=!1,a.num=n,game.rootScene.addChild(a),dices.push(a)}function o(e){switch(e){case 1:dices[0].visible=!1,dices[1].visible=!1,dices[2].visible=!1,dices[3].visible=!0,shadows[0].visible=!1,shadows[1].visible=!1,shadows[2].visible=!1,shadows[3].visible=!0;break;case 2:dices[0].visible=!1,dices[1].visible=!0,dices[2].visible=!0,dices[3].visible=!1,shadows[0].visible=!1,shadows[1].visible=!0,shadows[2].visible=!0,shadows[3].visible=!1;break;case 3:dices[0].visible=!1,dices[1].visible=!0,dices[2].visible=!0,dices[3].visible=!0,shadows[0].visible=!1,shadows[1].visible=!0,shadows[2].visible=!0,shadows[3].visible=!0;break;case 4:dices[0].visible=!0,dices[1].visible=!0,dices[2].visible=!0,dices[3].visible=!0,shadows[0].visible=!0,shadows[1].visible=!0,shadows[2].visible=!0,shadows[3].visible=!0;break;default:}}o(e),plus=new Sprite(256,256),plus_sf=new Surface(256,256),plus_sf.context.shadowColor="#000055",plus_sf.context.shadowBlur=5,plus_sf.draw(game.assets[PLUS_IMG]),plus.image=plus_sf,plus.originX=0,plus.scale(.3,.3),plus.moveTo(530,460),game.rootScene.addChild(plus),(minus=new Sprite(256,256)).image=game.assets[MINUS_IMG],minus.originX=0,minus.scale(.3,.3),minus.moveTo(30,460),game.rootScene.addChild(minus),(roll_btn=new Sprite(512,256)).image=game.assets[ROLL_IMG],roll_btn.scale(.3,.3),roll_btn.moveTo(STAGE_WIDTH/2-roll_btn.width/2,460),game.rootScene.addChild(roll_btn),roll_btn.addEventListener("touchstart",(function(){this.x+=2,this.y+=2})),roll_btn.addEventListener("touchend",(function(){this.x-=2,this.y-=2,this.visible=!1,plus.visible=!1,minus.visible=!1;for(var e=0;e<4;e++)dices[e].jump()})),plus.addEventListener("touchstart",(function(){this.x+=2,this.y+=2})),plus.addEventListener("touchend",(function(){e<4&&o(++e),this.x-=2,this.y-=2})),minus.addEventListener("touchstart",(function(){this.x+=2,this.y+=2})),minus.addEventListener("touchend",(function(){1<e&&o(--e),this.x-=2,this.y-=2}))},game.start()};var Dice=Class.create(Sprite,{initialize:function(){Sprite.call(this,256,256),this.image=game.assets[DICE_IMG],this.scale(1.1,1.1),this.anime=[0,6,1,7,2,8,3,9,4,10,5],this.tick=Math.floor(11*Math.random())},jump:function(){this.tl.delay(3*Math.random()).then((function(){this.onenterframe=function(){this.tick++,this.frame=this.anime[this.tick%this.anime.length]},shadows[this.num].animate()})).moveBy(0,-280,12,enchant.Easing.QUAD_EASEOUT).moveBy(0,280,12,enchant.Easing.QUAD_EASEIN).moveBy(0,-150,6,enchant.Easing.QUAD_EASEOUT).moveBy(0,150,6,enchant.Easing.QUAD_EASEIN).moveBy(0,-50,3,enchant.Easing.QUAD_EASEOUT).moveBy(0,50,3,enchant.Easing.QUAD_EASEIN).rotateBy(5,2,enchant.Easing.QUAD_EASEOUT).rotateBy(-5,2,enchant.Easing.QUAD_EASEIN).then((function(){this.onenterframe=null,this.frame=Math.floor(6*Math.random()),roll_btn.visible=!0,plus.visible=!0,minus.visible=!0}))}}),Shadow=Class.create(Sprite,{initialize:function(){Sprite.call(this,256,256),this.scale(shadow_scale);let e=new Surface(256,256);e.context.shadowColor="#000055",e.context.shadowBlur=35,e.draw(game.assets[KAGE_IMG]),this.image=e,this.opacity=.6},animate:function(){this.tl.scaleTo(.5,.5,12,enchant.Easing.QUAD_EASEOUT).scaleTo(shadow_scale,shadow_scale,12,enchant.Easing.QUAD_EASEIN).scaleTo(.6,.6,6,enchant.Easing.QUAD_EASEOUT).scaleTo(shadow_scale,shadow_scale,6,enchant.Easing.QUAD_EASEIN).scaleTo(.7,.7,3,enchant.Easing.QUAD_EASEOUT).scaleTo(shadow_scale,shadow_scale,3,enchant.Easing.QUAD_EASEIN)}});function centeringBody(){window.innerWidth>window.innerHeight&&window.innerHeight/window.innerWidth<STAGE_HEIGHT/STAGE_WIDTH||window.innerWidth<window.innerHeight&&window.innerHeight/window.innerWidth<STAGE_HEIGHT/STAGE_WIDTH?(document.getElementById("myStage").style.position="absolute",document.getElementById("myStage").style.top="0px",document.getElementById("myStage").style.left=(window.innerWidth-STAGE_WIDTH*window.innerHeight/STAGE_HEIGHT)/2+"px"):(window.innerWidth<window.innerHeight&&window.innerHeight/window.innerWidth>STAGE_HEIGHT/STAGE_WIDTH||window.innerWidth>window.innerHeight&&window.innerHeight/window.innerWidth>STAGE_HEIGHT/STAGE_WIDTH)&&(document.getElementById("myStage").style.position="absolute",document.getElementById("myStage").style.left="0px",document.getElementById("myStage").style.top=(window.innerHeight-STAGE_HEIGHT*window.innerWidth/STAGE_WIDTH)/2+"px")}Surface.prototype.fillGradient=function(e,i,s,n,t,a){this.context.beginPath();var o=this.context.createLinearGradient(0,0,0,640);o.addColorStop(1,t),o.addColorStop(0,a),this.context.fillStyle=o,this.context.rect(0,0,640,640),this.context.fill()};</script>
    <style type="text/css">
        body {
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body id="myStage">
</body>

</html>
